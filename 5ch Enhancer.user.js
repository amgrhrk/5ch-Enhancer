// ==UserScript==
// @name         5ch Enhancer
// @namespace    amgrhrk
// @version      0.1
// @description  Shows thumbnail previews and tweets for 5ch threads, and more.
// @description:ja 5ちゃんねるのスレにある画像のサムネイルとツイートを表示します+α
// @description:zh-cn 显示5ch串里图片链接的缩略图
// @author       文件
// @match        http://*.5ch.net/*
// @match        https://*.5ch.net/*
// @match        http://*.2ch.sc/*
// @match        https://*.2ch.sc/*
// @match        http://*.bbspink.com/*
// @match        https://*.bbspink.com/*
// @exclude      http://info.5ch.net/*
// @exclude      https://info.5ch.net/*
// @run-at       document-start
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @connect      twitter.com
// @connect      imgur.com
// ==/UserScript==

(function () {
    "use strict";
    function insertAfter(first, after) {
        var _a;
        (_a = first.parentNode) === null || _a === void 0 ? void 0 : _a.insertBefore(after, first.nextSibling);
    }
    function createTweet(json) {
        try {
            const obj = JSON.parse(json);
            const div = document.createElement('div');
            div.innerHTML = obj.html;
            return div;
        }
        catch (err) {
            return null;
        }
    }
    function trimTwitterImageUrl(url) {
        if (!url.includes('twimg')) {
            return url;
        }
        if (url.endsWith('orig')) {
            return url;
        }
        if (url.endsWith('&')) {
            return `${url}name=orig`;
        }
        const suffixes = ['large', 'medium', 'small', '900x900', 'thumb'];
        for (const suffix of suffixes) {
            if (url.endsWith(suffix)) {
                return `${url.substring(0, url.length - suffix.length)}orig`;
            }
        }
        return url;
    }
    const getHash = (() => {
        const resolves = new Map();
        const rejects = new Map();
        let globalId = 0;
        const worker = new Worker('data:text/javascript;base64,Y29uc3QgQmxvY2tIYXNoID0ge307CkJsb2NrSGFzaC5vbmVfYml0cyA9IFswLCAxLCAxLCAyLCAxLCAyLCAyLCAzLCAxLCAyLCAyLCAzLCAyLCAzLCAzLCA0XTsKQmxvY2tIYXNoLmhhbW1pbmdEaXN0YW5jZSA9IGZ1bmN0aW9uIChoYXNoMSwgaGFzaDIpIHsKICB2YXIgZCA9IDA7CiAgdmFyIGk7CiAgaWYgKGhhc2gxLmxlbmd0aCAhPT0gaGFzaDIubGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbid0IGNvbXBhcmUgaGFzaGVzIHdpdGggZGlmZmVyZW50IGxlbmd0aCIpOwogIH0KICBmb3IgKGkgPSAwOyBpIDwgaGFzaDEubGVuZ3RoOyBpKyspIHsKICAgIHZhciBuMSA9IHBhcnNlSW50KGhhc2gxW2ldLCAxNik7CiAgICB2YXIgbjIgPSBwYXJzZUludChoYXNoMltpXSwgMTYpOwogICAgZCArPSBvbmVfYml0c1tuMSBeIG4yXTsKICB9CiAgcmV0dXJuIGQ7Cn07CkJsb2NrSGFzaC5tZWRpYW4gPSBmdW5jdGlvbiAoZGF0YSkgewogIHZhciBtZGFyciA9IGRhdGEuc2xpY2UoMCk7CiAgbWRhcnIuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYSAtIGI7IH0pOwogIGlmIChtZGFyci5sZW5ndGggJSAyID09PSAwKSB7CiAgICByZXR1cm4gKG1kYXJyW21kYXJyLmxlbmd0aCAvIDIgLSAxXSArIG1kYXJyW21kYXJyLmxlbmd0aCAvIDJdKSAvIDIuMDsKICB9CiAgcmV0dXJuIG1kYXJyW01hdGguZmxvb3IobWRhcnIubGVuZ3RoIC8gMildOwp9OwpCbG9ja0hhc2gudHJhbnNsYXRlX2Jsb2Nrc190b19iaXRzID0gZnVuY3Rpb24gKGJsb2NrcywgcGl4ZWxzX3Blcl9ibG9jaykgewogIHZhciBoYWxmX2Jsb2NrX3ZhbHVlID0gcGl4ZWxzX3Blcl9ibG9jayAqIDI1NiAqIDMgLyAyOwogIHZhciBiYW5kc2l6ZSA9IGJsb2Nrcy5sZW5ndGggLyA0OwogIGZvciAodmFyIGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICB2YXIgbSA9IEJsb2NrSGFzaC5tZWRpYW4oYmxvY2tzLnNsaWNlKGkgKiBiYW5kc2l6ZSwgKGkgKyAxKSAqIGJhbmRzaXplKSk7CiAgICBmb3IgKHZhciBqID0gaSAqIGJhbmRzaXplOyBqIDwgKGkgKyAxKSAqIGJhbmRzaXplOyBqKyspIHsKICAgICAgdmFyIHYgPSBibG9ja3Nbal07CiAgICAgIGJsb2Nrc1tqXSA9IE51bWJlcih2ID4gbSB8fCAoTWF0aC5hYnModiAtIG0pIDwgMSAmJiBtID4gaGFsZl9ibG9ja192YWx1ZSkpOwogICAgfQogIH0KfTsKQmxvY2tIYXNoLmJpdHNfdG9faGV4aGFzaCA9IGZ1bmN0aW9uIChiaXRzQXJyYXkpIHsKICB2YXIgaGV4ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaXRzQXJyYXkubGVuZ3RoOyBpICs9IDQpIHsKICAgIHZhciBuaWJibGUgPSBiaXRzQXJyYXkuc2xpY2UoaSwgaSArIDQpOwogICAgaGV4LnB1c2gocGFyc2VJbnQobmliYmxlLmpvaW4oJycpLCAyKS50b1N0cmluZygxNikpOwogIH0KICByZXR1cm4gaGV4LmpvaW4oJycpOwp9OwpCbG9ja0hhc2guYm12Ymhhc2hfZXZlbiA9IGZ1bmN0aW9uIChkYXRhLCBiaXRzKSB7CiAgdmFyIGJsb2Nrc2l6ZV94ID0gTWF0aC5mbG9vcihkYXRhLndpZHRoIC8gYml0cyk7CiAgdmFyIGJsb2Nrc2l6ZV95ID0gTWF0aC5mbG9vcihkYXRhLmhlaWdodCAvIGJpdHMpOwogIHZhciByZXN1bHQgPSBbXTsKICBmb3IgKHZhciB5ID0gMDsgeSA8IGJpdHM7IHkrKykgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCBiaXRzOyB4KyspIHsKICAgICAgdmFyIHRvdGFsID0gMDsKICAgICAgZm9yICh2YXIgaXkgPSAwOyBpeSA8IGJsb2Nrc2l6ZV95OyBpeSsrKSB7CiAgICAgICAgZm9yICh2YXIgaXggPSAwOyBpeCA8IGJsb2Nrc2l6ZV94OyBpeCsrKSB7CiAgICAgICAgICB2YXIgY3ggPSB4ICogYmxvY2tzaXplX3ggKyBpeDsKICAgICAgICAgIHZhciBjeSA9IHkgKiBibG9ja3NpemVfeSArIGl5OwogICAgICAgICAgdmFyIGlpID0gKGN5ICogZGF0YS53aWR0aCArIGN4KSAqIDQ7CiAgICAgICAgICB2YXIgYWxwaGEgPSBkYXRhLmRhdGFbaWkgKyAzXTsKICAgICAgICAgIGlmIChhbHBoYSA9PT0gMCkgewogICAgICAgICAgICB0b3RhbCArPSA3NjU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b3RhbCArPSBkYXRhLmRhdGFbaWldICsgZGF0YS5kYXRhW2lpICsgMV0gKyBkYXRhLmRhdGFbaWkgKyAyXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2godG90YWwpOwogICAgfQogIH0KICBCbG9ja0hhc2gudHJhbnNsYXRlX2Jsb2Nrc190b19iaXRzKHJlc3VsdCwgYmxvY2tzaXplX3ggKiBibG9ja3NpemVfeSk7CiAgcmV0dXJuIEJsb2NrSGFzaC5iaXRzX3RvX2hleGhhc2gocmVzdWx0KTsKfTsKQmxvY2tIYXNoLmJtdmJoYXNoID0gZnVuY3Rpb24gKGRhdGEsIGJpdHMpIHsKICB2YXIgcmVzdWx0ID0gW107CiAgdmFyIGksIGosIHgsIHk7CiAgdmFyIGJsb2NrX3dpZHRoLCBibG9ja19oZWlnaHQ7CiAgdmFyIHdlaWdodF90b3AsIHdlaWdodF9ib3R0b20sIHdlaWdodF9sZWZ0LCB3ZWlnaHRfcmlnaHQ7CiAgdmFyIGJsb2NrX3RvcCwgYmxvY2tfYm90dG9tLCBibG9ja19sZWZ0LCBibG9ja19yaWdodDsKICB2YXIgeV9tb2QsIHlfZnJhYywgeV9pbnQ7CiAgdmFyIHhfbW9kLCB4X2ZyYWMsIHhfaW50OwogIHZhciBibG9ja3MgPSBbXTsKICB2YXIgZXZlbl94ID0gZGF0YS53aWR0aCAlIGJpdHMgPT09IDA7CiAgdmFyIGV2ZW5feSA9IGRhdGEuaGVpZ2h0ICUgYml0cyA9PT0gMDsKICBpZiAoZXZlbl94ICYmIGV2ZW5feSkgewogICAgcmV0dXJuIEJsb2NrSGFzaC5ibXZiaGFzaF9ldmVuKGRhdGEsIGJpdHMpOwogIH0KICBmb3IgKGkgPSAwOyBpIDwgYml0czsgaSsrKSB7CiAgICBibG9ja3MucHVzaChbXSk7CiAgICBmb3IgKGogPSAwOyBqIDwgYml0czsgaisrKSB7CiAgICAgIGJsb2Nrc1tpXS5wdXNoKDApOwogICAgfQogIH0KICBibG9ja193aWR0aCA9IGRhdGEud2lkdGggLyBiaXRzOwogIGJsb2NrX2hlaWdodCA9IGRhdGEuaGVpZ2h0IC8gYml0czsKICBmb3IgKHkgPSAwOyB5IDwgZGF0YS5oZWlnaHQ7IHkrKykgewogICAgaWYgKGV2ZW5feSkgewogICAgICBibG9ja190b3AgPSBibG9ja19ib3R0b20gPSBNYXRoLmZsb29yKHkgLyBibG9ja19oZWlnaHQpOwogICAgICB3ZWlnaHRfdG9wID0gMTsKICAgICAgd2VpZ2h0X2JvdHRvbSA9IDA7CiAgICB9IGVsc2UgewogICAgICB5X21vZCA9ICh5ICsgMSkgJSBibG9ja19oZWlnaHQ7CiAgICAgIHlfZnJhYyA9IHlfbW9kIC0gTWF0aC5mbG9vcih5X21vZCk7CiAgICAgIHlfaW50ID0geV9tb2QgLSB5X2ZyYWM7CiAgICAgIHdlaWdodF90b3AgPSAoMSAtIHlfZnJhYyk7CiAgICAgIHdlaWdodF9ib3R0b20gPSAoeV9mcmFjKTsKICAgICAgaWYgKHlfaW50ID4gMCB8fCAoeSArIDEpID09PSBkYXRhLmhlaWdodCkgewogICAgICAgIGJsb2NrX3RvcCA9IGJsb2NrX2JvdHRvbSA9IE1hdGguZmxvb3IoeSAvIGJsb2NrX2hlaWdodCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYmxvY2tfdG9wID0gTWF0aC5mbG9vcih5IC8gYmxvY2tfaGVpZ2h0KTsKICAgICAgICBibG9ja19ib3R0b20gPSBNYXRoLmNlaWwoeSAvIGJsb2NrX2hlaWdodCk7CiAgICAgIH0KICAgIH0KICAgIGZvciAoeCA9IDA7IHggPCBkYXRhLndpZHRoOyB4KyspIHsKICAgICAgdmFyIGlpID0gKHkgKiBkYXRhLndpZHRoICsgeCkgKiA0OwogICAgICB2YXIgYXZndmFsdWUsIGFscGhhID0gZGF0YS5kYXRhW2lpICsgM107CiAgICAgIGlmIChhbHBoYSA9PT0gMCkgewogICAgICAgIGF2Z3ZhbHVlID0gNzY1OwogICAgICB9IGVsc2UgewogICAgICAgIGF2Z3ZhbHVlID0gZGF0YS5kYXRhW2lpXSArIGRhdGEuZGF0YVtpaSArIDFdICsgZGF0YS5kYXRhW2lpICsgMl07CiAgICAgIH0KICAgICAgaWYgKGV2ZW5feCkgewogICAgICAgIGJsb2NrX2xlZnQgPSBibG9ja19yaWdodCA9IE1hdGguZmxvb3IoeCAvIGJsb2NrX3dpZHRoKTsKICAgICAgICB3ZWlnaHRfbGVmdCA9IDE7CiAgICAgICAgd2VpZ2h0X3JpZ2h0ID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB4X21vZCA9ICh4ICsgMSkgJSBibG9ja193aWR0aDsKICAgICAgICB4X2ZyYWMgPSB4X21vZCAtIE1hdGguZmxvb3IoeF9tb2QpOwogICAgICAgIHhfaW50ID0geF9tb2QgLSB4X2ZyYWM7CiAgICAgICAgd2VpZ2h0X2xlZnQgPSAoMSAtIHhfZnJhYyk7CiAgICAgICAgd2VpZ2h0X3JpZ2h0ID0geF9mcmFjOwogICAgICAgIGlmICh4X2ludCA+IDAgfHwgKHggKyAxKSA9PT0gZGF0YS53aWR0aCkgewogICAgICAgICAgYmxvY2tfbGVmdCA9IGJsb2NrX3JpZ2h0ID0gTWF0aC5mbG9vcih4IC8gYmxvY2tfd2lkdGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBibG9ja19sZWZ0ID0gTWF0aC5mbG9vcih4IC8gYmxvY2tfd2lkdGgpOwogICAgICAgICAgYmxvY2tfcmlnaHQgPSBNYXRoLmNlaWwoeCAvIGJsb2NrX3dpZHRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmxvY2tzW2Jsb2NrX3RvcF1bYmxvY2tfbGVmdF0gKz0gYXZndmFsdWUgKiB3ZWlnaHRfdG9wICogd2VpZ2h0X2xlZnQ7CiAgICAgIGJsb2Nrc1tibG9ja190b3BdW2Jsb2NrX3JpZ2h0XSArPSBhdmd2YWx1ZSAqIHdlaWdodF90b3AgKiB3ZWlnaHRfcmlnaHQ7CiAgICAgIGJsb2Nrc1tibG9ja19ib3R0b21dW2Jsb2NrX2xlZnRdICs9IGF2Z3ZhbHVlICogd2VpZ2h0X2JvdHRvbSAqIHdlaWdodF9sZWZ0OwogICAgICBibG9ja3NbYmxvY2tfYm90dG9tXVtibG9ja19yaWdodF0gKz0gYXZndmFsdWUgKiB3ZWlnaHRfYm90dG9tICogd2VpZ2h0X3JpZ2h0OwogICAgfQogIH0KICBmb3IgKGkgPSAwOyBpIDwgYml0czsgaSsrKSB7CiAgICBmb3IgKGogPSAwOyBqIDwgYml0czsgaisrKSB7CiAgICAgIHJlc3VsdC5wdXNoKGJsb2Nrc1tpXVtqXSk7CiAgICB9CiAgfQogIEJsb2NrSGFzaC50cmFuc2xhdGVfYmxvY2tzX3RvX2JpdHMocmVzdWx0LCBibG9ja193aWR0aCAqIGJsb2NrX2hlaWdodCk7CiAgcmV0dXJuIEJsb2NrSGFzaC5iaXRzX3RvX2hleGhhc2gocmVzdWx0KTsKfTsKQmxvY2tIYXNoLmJsb2NraGFzaERhdGEgPSBmdW5jdGlvbiAoaW1nRGF0YSwgYml0cywgbWV0aG9kKSB7CiAgdmFyIGhhc2g7CiAgaWYgKG1ldGhvZCA9PT0gMSkgewogICAgaGFzaCA9IEJsb2NrSGFzaC5ibXZiaGFzaF9ldmVuKGltZ0RhdGEsIGJpdHMpOwogIH0KICBlbHNlIGlmIChtZXRob2QgPT09IDIpIHsKICAgIGhhc2ggPSBCbG9ja0hhc2guYm12Ymhhc2goaW1nRGF0YSwgYml0cyk7CiAgfQogIGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKCJCYWQgaGFzaGluZyBtZXRob2QiKTsKICB9CiAgcmV0dXJuIGhhc2g7Cn07CkJsb2NrSGFzaC5ibG9ja2hhc2ggPSBmdW5jdGlvbiAoYXJyYXlCdWZmZXIsIGJpdHMsIG1ldGhvZCwgY2FsbGJhY2spIHsKICB2YXIgaW1nRGF0YSwgaGFzaDsKICB0cnkgewogICAgaW1nRGF0YSA9IHNlbGZbJ2pwZWctanMnXS5kZWNvZGUoYXJyYXlCdWZmZXIsIHsgdXNlVEFycmF5OiB0cnVlIH0pOwogICAgaWYgKCFpbWdEYXRhKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZGVjb2RlIGltYWdlIik7CiAgICB9CiAgICBoYXNoID0gQmxvY2tIYXNoLmJsb2NraGFzaERhdGEoaW1nRGF0YSwgYml0cywgbWV0aG9kKTsKICAgIGNhbGxiYWNrKG51bGwsIGhhc2gpOwogIH0gY2F0Y2ggKGVycikgewogICAgY2FsbGJhY2soZXJyLCBudWxsKTsKICB9Cn07CnZhciBKcGVnSW1hZ2UgPSAoZnVuY3Rpb24ganBlZ0ltYWdlKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgZGN0WmlnWmFnID0gbmV3IEludDMyQXJyYXkoWwogICAgMCwKICAgIDEsIDgsCiAgICAxNiwgOSwgMiwKICAgIDMsIDEwLCAxNywgMjQsCiAgICAzMiwgMjUsIDE4LCAxMSwgNCwKICAgIDUsIDEyLCAxOSwgMjYsIDMzLCA0MCwKICAgIDQ4LCA0MSwgMzQsIDI3LCAyMCwgMTMsIDYsCiAgICA3LCAxNCwgMjEsIDI4LCAzNSwgNDIsIDQ5LCA1NiwKICAgIDU3LCA1MCwgNDMsIDM2LCAyOSwgMjIsIDE1LAogICAgMjMsIDMwLCAzNywgNDQsIDUxLCA1OCwKICAgIDU5LCA1MiwgNDUsIDM4LCAzMSwKICAgIDM5LCA0NiwgNTMsIDYwLAogICAgNjEsIDU0LCA0NywKICAgIDU1LCA2MiwKICAgIDYzCiAgXSk7CiAgdmFyIGRjdENvczEgPSA0MDE3ICAgLy8gY29zKHBpLzE2KQogIHZhciBkY3RTaW4xID0gNzk5ICAgLy8gc2luKHBpLzE2KQogIHZhciBkY3RDb3MzID0gMzQwNiAgIC8vIGNvcygzKnBpLzE2KQogIHZhciBkY3RTaW4zID0gMjI3NiAgIC8vIHNpbigzKnBpLzE2KQogIHZhciBkY3RDb3M2ID0gMTU2NyAgIC8vIGNvcyg2KnBpLzE2KQogIHZhciBkY3RTaW42ID0gMzc4NCAgIC8vIHNpbig2KnBpLzE2KQogIHZhciBkY3RTcXJ0MiA9IDU3OTMgICAvLyBzcXJ0KDIpCiAgdmFyIGRjdFNxcnQxZDIgPSAyODk2ICAvLyBzcXJ0KDIpIC8gMgogIGZ1bmN0aW9uIGNvbnN0cnVjdG9yKCkgewogIH0KICBmdW5jdGlvbiBidWlsZEh1ZmZtYW5UYWJsZShjb2RlTGVuZ3RocywgdmFsdWVzKSB7CiAgICB2YXIgayA9IDAsIGNvZGUgPSBbXSwgaSwgaiwgbGVuZ3RoID0gMTY7CiAgICB3aGlsZSAobGVuZ3RoID4gMCAmJiAhY29kZUxlbmd0aHNbbGVuZ3RoIC0gMV0pCiAgICAgIGxlbmd0aC0tOwogICAgY29kZS5wdXNoKHsgY2hpbGRyZW46IFtdLCBpbmRleDogMCB9KTsKICAgIHZhciBwID0gY29kZVswXSwgcTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBmb3IgKGogPSAwOyBqIDwgY29kZUxlbmd0aHNbaV07IGorKykgewogICAgICAgIHAgPSBjb2RlLnBvcCgpOwogICAgICAgIHAuY2hpbGRyZW5bcC5pbmRleF0gPSB2YWx1ZXNba107CiAgICAgICAgd2hpbGUgKHAuaW5kZXggPiAwKSB7CiAgICAgICAgICBpZiAoY29kZS5sZW5ndGggPT09IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IHJlY3JlYXRlIEh1ZmZtYW4gVGFibGUnKTsKICAgICAgICAgIHAgPSBjb2RlLnBvcCgpOwogICAgICAgIH0KICAgICAgICBwLmluZGV4Kys7CiAgICAgICAgY29kZS5wdXNoKHApOwogICAgICAgIHdoaWxlIChjb2RlLmxlbmd0aCA8PSBpKSB7CiAgICAgICAgICBjb2RlLnB1c2gocSA9IHsgY2hpbGRyZW46IFtdLCBpbmRleDogMCB9KTsKICAgICAgICAgIHAuY2hpbGRyZW5bcC5pbmRleF0gPSBxLmNoaWxkcmVuOwogICAgICAgICAgcCA9IHE7CiAgICAgICAgfQogICAgICAgIGsrKzsKICAgICAgfQogICAgICBpZiAoaSArIDEgPCBsZW5ndGgpIHsKICAgICAgICAvLyBwIGhlcmUgcG9pbnRzIHRvIGxhc3QgY29kZQogICAgICAgIGNvZGUucHVzaChxID0geyBjaGlsZHJlbjogW10sIGluZGV4OiAwIH0pOwogICAgICAgIHAuY2hpbGRyZW5bcC5pbmRleF0gPSBxLmNoaWxkcmVuOwogICAgICAgIHAgPSBxOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29kZVswXS5jaGlsZHJlbjsKICB9CiAgZnVuY3Rpb24gZGVjb2RlU2NhbihkYXRhLCBvZmZzZXQsCiAgICBmcmFtZSwgY29tcG9uZW50cywgcmVzZXRJbnRlcnZhbCwKICAgIHNwZWN0cmFsU3RhcnQsIHNwZWN0cmFsRW5kLAogICAgc3VjY2Vzc2l2ZVByZXYsIHN1Y2Nlc3NpdmUsIG9wdHMpIHsKICAgIHZhciBwcmVjaXNpb24gPSBmcmFtZS5wcmVjaXNpb247CiAgICB2YXIgc2FtcGxlc1BlckxpbmUgPSBmcmFtZS5zYW1wbGVzUGVyTGluZTsKICAgIHZhciBzY2FuTGluZXMgPSBmcmFtZS5zY2FuTGluZXM7CiAgICB2YXIgbWN1c1BlckxpbmUgPSBmcmFtZS5tY3VzUGVyTGluZTsKICAgIHZhciBwcm9ncmVzc2l2ZSA9IGZyYW1lLnByb2dyZXNzaXZlOwogICAgdmFyIG1heEggPSBmcmFtZS5tYXhILCBtYXhWID0gZnJhbWUubWF4VjsKICAgIHZhciBzdGFydE9mZnNldCA9IG9mZnNldCwgYml0c0RhdGEgPSAwLCBiaXRzQ291bnQgPSAwOwogICAgZnVuY3Rpb24gcmVhZEJpdCgpIHsKICAgICAgaWYgKGJpdHNDb3VudCA+IDApIHsKICAgICAgICBiaXRzQ291bnQtLTsKICAgICAgICByZXR1cm4gKGJpdHNEYXRhID4+IGJpdHNDb3VudCkgJiAxOwogICAgICB9CiAgICAgIGJpdHNEYXRhID0gZGF0YVtvZmZzZXQrK107CiAgICAgIGlmIChiaXRzRGF0YSA9PSAweEZGKSB7CiAgICAgICAgdmFyIG5leHRCeXRlID0gZGF0YVtvZmZzZXQrK107CiAgICAgICAgaWYgKG5leHRCeXRlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVuZXhwZWN0ZWQgbWFya2VyOiAiICsgKChiaXRzRGF0YSA8PCA4KSB8IG5leHRCeXRlKS50b1N0cmluZygxNikpOwogICAgICAgIH0KICAgICAgICAvLyB1bnN0dWZmIDAKICAgICAgfQogICAgICBiaXRzQ291bnQgPSA3OwogICAgICByZXR1cm4gYml0c0RhdGEgPj4+IDc7CiAgICB9CiAgICBmdW5jdGlvbiBkZWNvZGVIdWZmbWFuKHRyZWUpIHsKICAgICAgdmFyIG5vZGUgPSB0cmVlLCBiaXQ7CiAgICAgIHdoaWxlICgoYml0ID0gcmVhZEJpdCgpKSAhPT0gbnVsbCkgewogICAgICAgIG5vZGUgPSBub2RlW2JpdF07CiAgICAgICAgaWYgKHR5cGVvZiBub2RlID09PSAnbnVtYmVyJykKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gJ29iamVjdCcpCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgaHVmZm1hbiBzZXF1ZW5jZSIpOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gcmVjZWl2ZShsZW5ndGgpIHsKICAgICAgdmFyIG4gPSAwOwogICAgICB3aGlsZSAobGVuZ3RoID4gMCkgewogICAgICAgIHZhciBiaXQgPSByZWFkQml0KCk7CiAgICAgICAgaWYgKGJpdCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIG4gPSAobiA8PCAxKSB8IGJpdDsKICAgICAgICBsZW5ndGgtLTsKICAgICAgfQogICAgICByZXR1cm4gbjsKICAgIH0KICAgIGZ1bmN0aW9uIHJlY2VpdmVBbmRFeHRlbmQobGVuZ3RoKSB7CiAgICAgIHZhciBuID0gcmVjZWl2ZShsZW5ndGgpOwogICAgICBpZiAobiA+PSAxIDw8IChsZW5ndGggLSAxKSkKICAgICAgICByZXR1cm4gbjsKICAgICAgcmV0dXJuIG4gKyAoLTEgPDwgbGVuZ3RoKSArIDE7CiAgICB9CiAgICBmdW5jdGlvbiBkZWNvZGVCYXNlbGluZShjb21wb25lbnQsIHp6KSB7CiAgICAgIHZhciB0ID0gZGVjb2RlSHVmZm1hbihjb21wb25lbnQuaHVmZm1hblRhYmxlREMpOwogICAgICB2YXIgZGlmZiA9IHQgPT09IDAgPyAwIDogcmVjZWl2ZUFuZEV4dGVuZCh0KTsKICAgICAgenpbMF0gPSAoY29tcG9uZW50LnByZWQgKz0gZGlmZik7CiAgICAgIHZhciBrID0gMTsKICAgICAgd2hpbGUgKGsgPCA2NCkgewogICAgICAgIHZhciBycyA9IGRlY29kZUh1ZmZtYW4oY29tcG9uZW50Lmh1ZmZtYW5UYWJsZUFDKTsKICAgICAgICB2YXIgcyA9IHJzICYgMTUsIHIgPSBycyA+PiA0OwogICAgICAgIGlmIChzID09PSAwKSB7CiAgICAgICAgICBpZiAociA8IDE1KQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGsgKz0gMTY7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgayArPSByOwogICAgICAgIHZhciB6ID0gZGN0WmlnWmFnW2tdOwogICAgICAgIHp6W3pdID0gcmVjZWl2ZUFuZEV4dGVuZChzKTsKICAgICAgICBrKys7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZURDRmlyc3QoY29tcG9uZW50LCB6eikgewogICAgICB2YXIgdCA9IGRlY29kZUh1ZmZtYW4oY29tcG9uZW50Lmh1ZmZtYW5UYWJsZURDKTsKICAgICAgdmFyIGRpZmYgPSB0ID09PSAwID8gMCA6IChyZWNlaXZlQW5kRXh0ZW5kKHQpIDw8IHN1Y2Nlc3NpdmUpOwogICAgICB6elswXSA9IChjb21wb25lbnQucHJlZCArPSBkaWZmKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZURDU3VjY2Vzc2l2ZShjb21wb25lbnQsIHp6KSB7CiAgICAgIHp6WzBdIHw9IHJlYWRCaXQoKSA8PCBzdWNjZXNzaXZlOwogICAgfQogICAgdmFyIGVvYnJ1biA9IDA7CiAgICBmdW5jdGlvbiBkZWNvZGVBQ0ZpcnN0KGNvbXBvbmVudCwgenopIHsKICAgICAgaWYgKGVvYnJ1biA+IDApIHsKICAgICAgICBlb2JydW4tLTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGsgPSBzcGVjdHJhbFN0YXJ0LCBlID0gc3BlY3RyYWxFbmQ7CiAgICAgIHdoaWxlIChrIDw9IGUpIHsKICAgICAgICB2YXIgcnMgPSBkZWNvZGVIdWZmbWFuKGNvbXBvbmVudC5odWZmbWFuVGFibGVBQyk7CiAgICAgICAgdmFyIHMgPSBycyAmIDE1LCByID0gcnMgPj4gNDsKICAgICAgICBpZiAocyA9PT0gMCkgewogICAgICAgICAgaWYgKHIgPCAxNSkgewogICAgICAgICAgICBlb2JydW4gPSByZWNlaXZlKHIpICsgKDEgPDwgcikgLSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGsgKz0gMTY7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgayArPSByOwogICAgICAgIHZhciB6ID0gZGN0WmlnWmFnW2tdOwogICAgICAgIHp6W3pdID0gcmVjZWl2ZUFuZEV4dGVuZChzKSAqICgxIDw8IHN1Y2Nlc3NpdmUpOwogICAgICAgIGsrKzsKICAgICAgfQogICAgfQogICAgdmFyIHN1Y2Nlc3NpdmVBQ1N0YXRlID0gMCwgc3VjY2Vzc2l2ZUFDTmV4dFZhbHVlOwogICAgZnVuY3Rpb24gZGVjb2RlQUNTdWNjZXNzaXZlKGNvbXBvbmVudCwgenopIHsKICAgICAgdmFyIGsgPSBzcGVjdHJhbFN0YXJ0LCBlID0gc3BlY3RyYWxFbmQsIHIgPSAwOwogICAgICB3aGlsZSAoayA8PSBlKSB7CiAgICAgICAgdmFyIHogPSBkY3RaaWdaYWdba107CiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IHp6W3pdIDwgMCA/IC0xIDogMTsKICAgICAgICBzd2l0Y2ggKHN1Y2Nlc3NpdmVBQ1N0YXRlKSB7CiAgICAgICAgICBjYXNlIDA6IC8vIGluaXRpYWwgc3RhdGUKICAgICAgICAgICAgdmFyIHJzID0gZGVjb2RlSHVmZm1hbihjb21wb25lbnQuaHVmZm1hblRhYmxlQUMpOwogICAgICAgICAgICB2YXIgcyA9IHJzICYgMTUsIHIgPSBycyA+PiA0OwogICAgICAgICAgICBpZiAocyA9PT0gMCkgewogICAgICAgICAgICAgIGlmIChyIDwgMTUpIHsKICAgICAgICAgICAgICAgIGVvYnJ1biA9IHJlY2VpdmUocikgKyAoMSA8PCByKTsKICAgICAgICAgICAgICAgIHN1Y2Nlc3NpdmVBQ1N0YXRlID0gNDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgciA9IDE2OwogICAgICAgICAgICAgICAgc3VjY2Vzc2l2ZUFDU3RhdGUgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocyAhPT0gMSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCBBQ24gZW5jb2RpbmciKTsKICAgICAgICAgICAgICBzdWNjZXNzaXZlQUNOZXh0VmFsdWUgPSByZWNlaXZlQW5kRXh0ZW5kKHMpOwogICAgICAgICAgICAgIHN1Y2Nlc3NpdmVBQ1N0YXRlID0gciA/IDIgOiAzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgY2FzZSAxOiAvLyBza2lwcGluZyByIHplcm8gaXRlbXMKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgaWYgKHp6W3pdKQogICAgICAgICAgICAgIHp6W3pdICs9IChyZWFkQml0KCkgPDwgc3VjY2Vzc2l2ZSkgKiBkaXJlY3Rpb247CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHItLTsKICAgICAgICAgICAgICBpZiAociA9PT0gMCkKICAgICAgICAgICAgICAgIHN1Y2Nlc3NpdmVBQ1N0YXRlID0gc3VjY2Vzc2l2ZUFDU3RhdGUgPT0gMiA/IDMgOiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOiAvLyBzZXQgdmFsdWUgZm9yIGEgemVybyBpdGVtCiAgICAgICAgICAgIGlmICh6elt6XSkKICAgICAgICAgICAgICB6elt6XSArPSAocmVhZEJpdCgpIDw8IHN1Y2Nlc3NpdmUpICogZGlyZWN0aW9uOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB6elt6XSA9IHN1Y2Nlc3NpdmVBQ05leHRWYWx1ZSA8PCBzdWNjZXNzaXZlOwogICAgICAgICAgICAgIHN1Y2Nlc3NpdmVBQ1N0YXRlID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNDogLy8gZW9iCiAgICAgICAgICAgIGlmICh6elt6XSkKICAgICAgICAgICAgICB6elt6XSArPSAocmVhZEJpdCgpIDw8IHN1Y2Nlc3NpdmUpICogZGlyZWN0aW9uOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaysrOwogICAgICB9CiAgICAgIGlmIChzdWNjZXNzaXZlQUNTdGF0ZSA9PT0gNCkgewogICAgICAgIGVvYnJ1bi0tOwogICAgICAgIGlmIChlb2JydW4gPT09IDApCiAgICAgICAgICBzdWNjZXNzaXZlQUNTdGF0ZSA9IDA7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRlY29kZU1jdShjb21wb25lbnQsIGRlY29kZSwgbWN1LCByb3csIGNvbCkgewogICAgICB2YXIgbWN1Um93ID0gKG1jdSAvIG1jdXNQZXJMaW5lKSB8IDA7CiAgICAgIHZhciBtY3VDb2wgPSBtY3UgJSBtY3VzUGVyTGluZTsKICAgICAgdmFyIGJsb2NrUm93ID0gbWN1Um93ICogY29tcG9uZW50LnYgKyByb3c7CiAgICAgIHZhciBibG9ja0NvbCA9IG1jdUNvbCAqIGNvbXBvbmVudC5oICsgY29sOwogICAgICBpZiAoY29tcG9uZW50LmJsb2Nrc1tibG9ja1Jvd10gPT09IHVuZGVmaW5lZCAmJiBvcHRzLnRvbGVyYW50RGVjb2RpbmcpCiAgICAgICAgcmV0dXJuOwogICAgICBkZWNvZGUoY29tcG9uZW50LCBjb21wb25lbnQuYmxvY2tzW2Jsb2NrUm93XVtibG9ja0NvbF0pOwogICAgfQogICAgZnVuY3Rpb24gZGVjb2RlQmxvY2soY29tcG9uZW50LCBkZWNvZGUsIG1jdSkgewogICAgICB2YXIgYmxvY2tSb3cgPSAobWN1IC8gY29tcG9uZW50LmJsb2Nrc1BlckxpbmUpIHwgMDsKICAgICAgdmFyIGJsb2NrQ29sID0gbWN1ICUgY29tcG9uZW50LmJsb2Nrc1BlckxpbmU7CiAgICAgIGlmIChjb21wb25lbnQuYmxvY2tzW2Jsb2NrUm93XSA9PT0gdW5kZWZpbmVkICYmIG9wdHMudG9sZXJhbnREZWNvZGluZykKICAgICAgICByZXR1cm47CiAgICAgIGRlY29kZShjb21wb25lbnQsIGNvbXBvbmVudC5ibG9ja3NbYmxvY2tSb3ddW2Jsb2NrQ29sXSk7CiAgICB9CiAgICB2YXIgY29tcG9uZW50c0xlbmd0aCA9IGNvbXBvbmVudHMubGVuZ3RoOwogICAgdmFyIGNvbXBvbmVudCwgaSwgaiwgaywgbjsKICAgIHZhciBkZWNvZGVGbjsKICAgIGlmIChwcm9ncmVzc2l2ZSkgewogICAgICBpZiAoc3BlY3RyYWxTdGFydCA9PT0gMCkKICAgICAgICBkZWNvZGVGbiA9IHN1Y2Nlc3NpdmVQcmV2ID09PSAwID8gZGVjb2RlRENGaXJzdCA6IGRlY29kZURDU3VjY2Vzc2l2ZTsKICAgICAgZWxzZQogICAgICAgIGRlY29kZUZuID0gc3VjY2Vzc2l2ZVByZXYgPT09IDAgPyBkZWNvZGVBQ0ZpcnN0IDogZGVjb2RlQUNTdWNjZXNzaXZlOwogICAgfSBlbHNlIHsKICAgICAgZGVjb2RlRm4gPSBkZWNvZGVCYXNlbGluZTsKICAgIH0KICAgIHZhciBtY3UgPSAwLCBtYXJrZXI7CiAgICB2YXIgbWN1RXhwZWN0ZWQ7CiAgICBpZiAoY29tcG9uZW50c0xlbmd0aCA9PSAxKSB7CiAgICAgIG1jdUV4cGVjdGVkID0gY29tcG9uZW50c1swXS5ibG9ja3NQZXJMaW5lICogY29tcG9uZW50c1swXS5ibG9ja3NQZXJDb2x1bW47CiAgICB9IGVsc2UgewogICAgICBtY3VFeHBlY3RlZCA9IG1jdXNQZXJMaW5lICogZnJhbWUubWN1c1BlckNvbHVtbjsKICAgIH0KICAgIGlmICghcmVzZXRJbnRlcnZhbCkgcmVzZXRJbnRlcnZhbCA9IG1jdUV4cGVjdGVkOwogICAgdmFyIGgsIHY7CiAgICB3aGlsZSAobWN1IDwgbWN1RXhwZWN0ZWQpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGNvbXBvbmVudHNMZW5ndGg7IGkrKykKICAgICAgICBjb21wb25lbnRzW2ldLnByZWQgPSAwOwogICAgICBlb2JydW4gPSAwOwogICAgICBpZiAoY29tcG9uZW50c0xlbmd0aCA9PSAxKSB7CiAgICAgICAgY29tcG9uZW50ID0gY29tcG9uZW50c1swXTsKICAgICAgICBmb3IgKG4gPSAwOyBuIDwgcmVzZXRJbnRlcnZhbDsgbisrKSB7CiAgICAgICAgICBkZWNvZGVCbG9jayhjb21wb25lbnQsIGRlY29kZUZuLCBtY3UpOwogICAgICAgICAgbWN1Kys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAobiA9IDA7IG4gPCByZXNldEludGVydmFsOyBuKyspIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb21wb25lbnRzTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29tcG9uZW50ID0gY29tcG9uZW50c1tpXTsKICAgICAgICAgICAgaCA9IGNvbXBvbmVudC5oOwogICAgICAgICAgICB2ID0gY29tcG9uZW50LnY7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB2OyBqKyspIHsKICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgaDsgaysrKSB7CiAgICAgICAgICAgICAgICBkZWNvZGVNY3UoY29tcG9uZW50LCBkZWNvZGVGbiwgbWN1LCBqLCBrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1jdSsrOwogICAgICAgICAgaWYgKG1jdSA9PT0gbWN1RXhwZWN0ZWQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobWN1ID09PSBtY3VFeHBlY3RlZCkgewogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChkYXRhW29mZnNldF0gPT09IDB4RkYpIHsKICAgICAgICAgICAgaWYgKGRhdGFbb2Zmc2V0ICsgMV0gIT09IDB4MDApIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb2Zmc2V0ICs9IDE7CiAgICAgICAgfSB3aGlsZSAob2Zmc2V0IDwgZGF0YS5sZW5ndGggLSAyKTsKICAgICAgfQogICAgICBiaXRzQ291bnQgPSAwOwogICAgICBtYXJrZXIgPSAoZGF0YVtvZmZzZXRdIDw8IDgpIHwgZGF0YVtvZmZzZXQgKyAxXTsKICAgICAgaWYgKG1hcmtlciA8IDB4RkYwMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigibWFya2VyIHdhcyBub3QgZm91bmQiKTsKICAgICAgfQogICAgICBpZiAobWFya2VyID49IDB4RkZEMCAmJiBtYXJrZXIgPD0gMHhGRkQ3KSB7IC8vIFJTVHgKICAgICAgICBvZmZzZXQgKz0gMjsKICAgICAgfQogICAgICBlbHNlCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gb2Zmc2V0IC0gc3RhcnRPZmZzZXQ7CiAgfQogIGZ1bmN0aW9uIGJ1aWxkQ29tcG9uZW50RGF0YShmcmFtZSwgY29tcG9uZW50KSB7CiAgICB2YXIgbGluZXMgPSBbXTsKICAgIHZhciBibG9ja3NQZXJMaW5lID0gY29tcG9uZW50LmJsb2Nrc1BlckxpbmU7CiAgICB2YXIgYmxvY2tzUGVyQ29sdW1uID0gY29tcG9uZW50LmJsb2Nrc1BlckNvbHVtbjsKICAgIHZhciBzYW1wbGVzUGVyTGluZSA9IGJsb2Nrc1BlckxpbmUgPDwgMzsKICAgIHZhciBSID0gbmV3IEludDMyQXJyYXkoNjQpLCByID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwogICAgZnVuY3Rpb24gcXVhbnRpemVBbmRJbnZlcnNlKHp6LCBkYXRhT3V0LCBkYXRhSW4pIHsKICAgICAgdmFyIHF0ID0gY29tcG9uZW50LnF1YW50aXphdGlvblRhYmxlOwogICAgICB2YXIgdjAsIHYxLCB2MiwgdjMsIHY0LCB2NSwgdjYsIHY3LCB0OwogICAgICB2YXIgcCA9IGRhdGFJbjsKICAgICAgdmFyIGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCA2NDsgaSsrKQogICAgICAgIHBbaV0gPSB6eltpXSAqIHF0W2ldOwogICAgICBmb3IgKGkgPSAwOyBpIDwgODsgKytpKSB7CiAgICAgICAgdmFyIHJvdyA9IDggKiBpOwogICAgICAgIGlmIChwWzEgKyByb3ddID09IDAgJiYgcFsyICsgcm93XSA9PSAwICYmIHBbMyArIHJvd10gPT0gMCAmJgogICAgICAgICAgcFs0ICsgcm93XSA9PSAwICYmIHBbNSArIHJvd10gPT0gMCAmJiBwWzYgKyByb3ddID09IDAgJiYKICAgICAgICAgIHBbNyArIHJvd10gPT0gMCkgewogICAgICAgICAgdCA9IChkY3RTcXJ0MiAqIHBbMCArIHJvd10gKyA1MTIpID4+IDEwOwogICAgICAgICAgcFswICsgcm93XSA9IHQ7CiAgICAgICAgICBwWzEgKyByb3ddID0gdDsKICAgICAgICAgIHBbMiArIHJvd10gPSB0OwogICAgICAgICAgcFszICsgcm93XSA9IHQ7CiAgICAgICAgICBwWzQgKyByb3ddID0gdDsKICAgICAgICAgIHBbNSArIHJvd10gPSB0OwogICAgICAgICAgcFs2ICsgcm93XSA9IHQ7CiAgICAgICAgICBwWzcgKyByb3ddID0gdDsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICB2MCA9IChkY3RTcXJ0MiAqIHBbMCArIHJvd10gKyAxMjgpID4+IDg7CiAgICAgICAgdjEgPSAoZGN0U3FydDIgKiBwWzQgKyByb3ddICsgMTI4KSA+PiA4OwogICAgICAgIHYyID0gcFsyICsgcm93XTsKICAgICAgICB2MyA9IHBbNiArIHJvd107CiAgICAgICAgdjQgPSAoZGN0U3FydDFkMiAqIChwWzEgKyByb3ddIC0gcFs3ICsgcm93XSkgKyAxMjgpID4+IDg7CiAgICAgICAgdjcgPSAoZGN0U3FydDFkMiAqIChwWzEgKyByb3ddICsgcFs3ICsgcm93XSkgKyAxMjgpID4+IDg7CiAgICAgICAgdjUgPSBwWzMgKyByb3ddIDw8IDQ7CiAgICAgICAgdjYgPSBwWzUgKyByb3ddIDw8IDQ7CiAgICAgICAgdCA9ICh2MCAtIHYxICsgMSkgPj4gMTsKICAgICAgICB2MCA9ICh2MCArIHYxICsgMSkgPj4gMTsKICAgICAgICB2MSA9IHQ7CiAgICAgICAgdCA9ICh2MiAqIGRjdFNpbjYgKyB2MyAqIGRjdENvczYgKyAxMjgpID4+IDg7CiAgICAgICAgdjIgPSAodjIgKiBkY3RDb3M2IC0gdjMgKiBkY3RTaW42ICsgMTI4KSA+PiA4OwogICAgICAgIHYzID0gdDsKICAgICAgICB0ID0gKHY0IC0gdjYgKyAxKSA+PiAxOwogICAgICAgIHY0ID0gKHY0ICsgdjYgKyAxKSA+PiAxOwogICAgICAgIHY2ID0gdDsKICAgICAgICB0ID0gKHY3ICsgdjUgKyAxKSA+PiAxOwogICAgICAgIHY1ID0gKHY3IC0gdjUgKyAxKSA+PiAxOwogICAgICAgIHY3ID0gdDsKICAgICAgICB0ID0gKHYwIC0gdjMgKyAxKSA+PiAxOwogICAgICAgIHYwID0gKHYwICsgdjMgKyAxKSA+PiAxOwogICAgICAgIHYzID0gdDsKICAgICAgICB0ID0gKHYxIC0gdjIgKyAxKSA+PiAxOwogICAgICAgIHYxID0gKHYxICsgdjIgKyAxKSA+PiAxOwogICAgICAgIHYyID0gdDsKICAgICAgICB0ID0gKHY0ICogZGN0U2luMyArIHY3ICogZGN0Q29zMyArIDIwNDgpID4+IDEyOwogICAgICAgIHY0ID0gKHY0ICogZGN0Q29zMyAtIHY3ICogZGN0U2luMyArIDIwNDgpID4+IDEyOwogICAgICAgIHY3ID0gdDsKICAgICAgICB0ID0gKHY1ICogZGN0U2luMSArIHY2ICogZGN0Q29zMSArIDIwNDgpID4+IDEyOwogICAgICAgIHY1ID0gKHY1ICogZGN0Q29zMSAtIHY2ICogZGN0U2luMSArIDIwNDgpID4+IDEyOwogICAgICAgIHY2ID0gdDsKICAgICAgICBwWzAgKyByb3ddID0gdjAgKyB2NzsKICAgICAgICBwWzcgKyByb3ddID0gdjAgLSB2NzsKICAgICAgICBwWzEgKyByb3ddID0gdjEgKyB2NjsKICAgICAgICBwWzYgKyByb3ddID0gdjEgLSB2NjsKICAgICAgICBwWzIgKyByb3ddID0gdjIgKyB2NTsKICAgICAgICBwWzUgKyByb3ddID0gdjIgLSB2NTsKICAgICAgICBwWzMgKyByb3ddID0gdjMgKyB2NDsKICAgICAgICBwWzQgKyByb3ddID0gdjMgLSB2NDsKICAgICAgfQogICAgICBmb3IgKGkgPSAwOyBpIDwgODsgKytpKSB7CiAgICAgICAgdmFyIGNvbCA9IGk7CiAgICAgICAgaWYgKHBbMSAqIDggKyBjb2xdID09IDAgJiYgcFsyICogOCArIGNvbF0gPT0gMCAmJiBwWzMgKiA4ICsgY29sXSA9PSAwICYmCiAgICAgICAgICBwWzQgKiA4ICsgY29sXSA9PSAwICYmIHBbNSAqIDggKyBjb2xdID09IDAgJiYgcFs2ICogOCArIGNvbF0gPT0gMCAmJgogICAgICAgICAgcFs3ICogOCArIGNvbF0gPT0gMCkgewogICAgICAgICAgdCA9IChkY3RTcXJ0MiAqIGRhdGFJbltpICsgMF0gKyA4MTkyKSA+PiAxNDsKICAgICAgICAgIHBbMCAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbMSAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbMiAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbMyAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbNCAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbNSAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbNiAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIHBbNyAqIDggKyBjb2xdID0gdDsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICB2MCA9IChkY3RTcXJ0MiAqIHBbMCAqIDggKyBjb2xdICsgMjA0OCkgPj4gMTI7CiAgICAgICAgdjEgPSAoZGN0U3FydDIgKiBwWzQgKiA4ICsgY29sXSArIDIwNDgpID4+IDEyOwogICAgICAgIHYyID0gcFsyICogOCArIGNvbF07CiAgICAgICAgdjMgPSBwWzYgKiA4ICsgY29sXTsKICAgICAgICB2NCA9IChkY3RTcXJ0MWQyICogKHBbMSAqIDggKyBjb2xdIC0gcFs3ICogOCArIGNvbF0pICsgMjA0OCkgPj4gMTI7CiAgICAgICAgdjcgPSAoZGN0U3FydDFkMiAqIChwWzEgKiA4ICsgY29sXSArIHBbNyAqIDggKyBjb2xdKSArIDIwNDgpID4+IDEyOwogICAgICAgIHY1ID0gcFszICogOCArIGNvbF07CiAgICAgICAgdjYgPSBwWzUgKiA4ICsgY29sXTsKICAgICAgICB0ID0gKHYwIC0gdjEgKyAxKSA+PiAxOwogICAgICAgIHYwID0gKHYwICsgdjEgKyAxKSA+PiAxOwogICAgICAgIHYxID0gdDsKICAgICAgICB0ID0gKHYyICogZGN0U2luNiArIHYzICogZGN0Q29zNiArIDIwNDgpID4+IDEyOwogICAgICAgIHYyID0gKHYyICogZGN0Q29zNiAtIHYzICogZGN0U2luNiArIDIwNDgpID4+IDEyOwogICAgICAgIHYzID0gdDsKICAgICAgICB0ID0gKHY0IC0gdjYgKyAxKSA+PiAxOwogICAgICAgIHY0ID0gKHY0ICsgdjYgKyAxKSA+PiAxOwogICAgICAgIHY2ID0gdDsKICAgICAgICB0ID0gKHY3ICsgdjUgKyAxKSA+PiAxOwogICAgICAgIHY1ID0gKHY3IC0gdjUgKyAxKSA+PiAxOwogICAgICAgIHY3ID0gdDsKICAgICAgICB0ID0gKHYwIC0gdjMgKyAxKSA+PiAxOwogICAgICAgIHYwID0gKHYwICsgdjMgKyAxKSA+PiAxOwogICAgICAgIHYzID0gdDsKICAgICAgICB0ID0gKHYxIC0gdjIgKyAxKSA+PiAxOwogICAgICAgIHYxID0gKHYxICsgdjIgKyAxKSA+PiAxOwogICAgICAgIHYyID0gdDsKICAgICAgICB0ID0gKHY0ICogZGN0U2luMyArIHY3ICogZGN0Q29zMyArIDIwNDgpID4+IDEyOwogICAgICAgIHY0ID0gKHY0ICogZGN0Q29zMyAtIHY3ICogZGN0U2luMyArIDIwNDgpID4+IDEyOwogICAgICAgIHY3ID0gdDsKICAgICAgICB0ID0gKHY1ICogZGN0U2luMSArIHY2ICogZGN0Q29zMSArIDIwNDgpID4+IDEyOwogICAgICAgIHY1ID0gKHY1ICogZGN0Q29zMSAtIHY2ICogZGN0U2luMSArIDIwNDgpID4+IDEyOwogICAgICAgIHY2ID0gdDsKICAgICAgICBwWzAgKiA4ICsgY29sXSA9IHYwICsgdjc7CiAgICAgICAgcFs3ICogOCArIGNvbF0gPSB2MCAtIHY3OwogICAgICAgIHBbMSAqIDggKyBjb2xdID0gdjEgKyB2NjsKICAgICAgICBwWzYgKiA4ICsgY29sXSA9IHYxIC0gdjY7CiAgICAgICAgcFsyICogOCArIGNvbF0gPSB2MiArIHY1OwogICAgICAgIHBbNSAqIDggKyBjb2xdID0gdjIgLSB2NTsKICAgICAgICBwWzMgKiA4ICsgY29sXSA9IHYzICsgdjQ7CiAgICAgICAgcFs0ICogOCArIGNvbF0gPSB2MyAtIHY0OwogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCA2NDsgKytpKSB7CiAgICAgICAgdmFyIHNhbXBsZSA9IDEyOCArICgocFtpXSArIDgpID4+IDQpOwogICAgICAgIGRhdGFPdXRbaV0gPSBzYW1wbGUgPCAwID8gMCA6IHNhbXBsZSA+IDB4RkYgPyAweEZGIDogc2FtcGxlOwogICAgICB9CiAgICB9CiAgICByZXF1ZXN0TWVtb3J5QWxsb2NhdGlvbihzYW1wbGVzUGVyTGluZSAqIGJsb2Nrc1BlckNvbHVtbiAqIDgpOwogICAgdmFyIGksIGo7CiAgICBmb3IgKHZhciBibG9ja1JvdyA9IDA7IGJsb2NrUm93IDwgYmxvY2tzUGVyQ29sdW1uOyBibG9ja1JvdysrKSB7CiAgICAgIHZhciBzY2FuTGluZSA9IGJsb2NrUm93IDw8IDM7CiAgICAgIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspCiAgICAgICAgbGluZXMucHVzaChuZXcgVWludDhBcnJheShzYW1wbGVzUGVyTGluZSkpOwogICAgICBmb3IgKHZhciBibG9ja0NvbCA9IDA7IGJsb2NrQ29sIDwgYmxvY2tzUGVyTGluZTsgYmxvY2tDb2wrKykgewogICAgICAgIHF1YW50aXplQW5kSW52ZXJzZShjb21wb25lbnQuYmxvY2tzW2Jsb2NrUm93XVtibG9ja0NvbF0sIHIsIFIpOwogICAgICAgIHZhciBvZmZzZXQgPSAwLCBzYW1wbGUgPSBibG9ja0NvbCA8PCAzOwogICAgICAgIGZvciAoaiA9IDA7IGogPCA4OyBqKyspIHsKICAgICAgICAgIHZhciBsaW5lID0gbGluZXNbc2NhbkxpbmUgKyBqXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspCiAgICAgICAgICAgIGxpbmVbc2FtcGxlICsgaV0gPSByW29mZnNldCsrXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBsaW5lczsKICB9CiAgZnVuY3Rpb24gY2xhbXBUbzhiaXQoYSkgewogICAgcmV0dXJuIGEgPCAwID8gMCA6IGEgPiAyNTUgPyAyNTUgOiBhOwogIH0KICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSB7CiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKHBhdGgpIHsKICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICB4aHIub3BlbigiR0VUIiwgcGF0aCwgdHJ1ZSk7CiAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICB4aHIub25sb2FkID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZGF0YSA9IG5ldyBVaW50OEFycmF5KHhoci5yZXNwb25zZSB8fCB4aHIubW96UmVzcG9uc2VBcnJheUJ1ZmZlcik7CiAgICAgICAgdGhpcy5wYXJzZShkYXRhKTsKICAgICAgICBpZiAodGhpcy5vbmxvYWQpCiAgICAgICAgICB0aGlzLm9ubG9hZCgpOwogICAgICB9KS5iaW5kKHRoaXMpOwogICAgICB4aHIuc2VuZChudWxsKTsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24gcGFyc2UoZGF0YSkgewogICAgICB2YXIgbWF4UmVzb2x1dGlvbkluUGl4ZWxzID0gdGhpcy5vcHRzLm1heFJlc29sdXRpb25Jbk1QICogMTAwMCAqIDEwMDA7CiAgICAgIHZhciBvZmZzZXQgPSAwLCBsZW5ndGggPSBkYXRhLmxlbmd0aDsKICAgICAgZnVuY3Rpb24gcmVhZFVpbnQxNigpIHsKICAgICAgICB2YXIgdmFsdWUgPSAoZGF0YVtvZmZzZXRdIDw8IDgpIHwgZGF0YVtvZmZzZXQgKyAxXTsKICAgICAgICBvZmZzZXQgKz0gMjsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVhZERhdGFCbG9jaygpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gcmVhZFVpbnQxNigpOwogICAgICAgIHZhciBhcnJheSA9IGRhdGEuc3ViYXJyYXkob2Zmc2V0LCBvZmZzZXQgKyBsZW5ndGggLSAyKTsKICAgICAgICBvZmZzZXQgKz0gYXJyYXkubGVuZ3RoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcmVwYXJlQ29tcG9uZW50cyhmcmFtZSkgewogICAgICAgIHZhciBtYXhIID0gMCwgbWF4ViA9IDA7CiAgICAgICAgdmFyIGNvbXBvbmVudCwgY29tcG9uZW50SWQ7CiAgICAgICAgZm9yIChjb21wb25lbnRJZCBpbiBmcmFtZS5jb21wb25lbnRzKSB7CiAgICAgICAgICBpZiAoZnJhbWUuY29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShjb21wb25lbnRJZCkpIHsKICAgICAgICAgICAgY29tcG9uZW50ID0gZnJhbWUuY29tcG9uZW50c1tjb21wb25lbnRJZF07CiAgICAgICAgICAgIGlmIChtYXhIIDwgY29tcG9uZW50LmgpIG1heEggPSBjb21wb25lbnQuaDsKICAgICAgICAgICAgaWYgKG1heFYgPCBjb21wb25lbnQudikgbWF4ViA9IGNvbXBvbmVudC52OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgbWN1c1BlckxpbmUgPSBNYXRoLmNlaWwoZnJhbWUuc2FtcGxlc1BlckxpbmUgLyA4IC8gbWF4SCk7CiAgICAgICAgdmFyIG1jdXNQZXJDb2x1bW4gPSBNYXRoLmNlaWwoZnJhbWUuc2NhbkxpbmVzIC8gOCAvIG1heFYpOwogICAgICAgIGZvciAoY29tcG9uZW50SWQgaW4gZnJhbWUuY29tcG9uZW50cykgewogICAgICAgICAgaWYgKGZyYW1lLmNvbXBvbmVudHMuaGFzT3duUHJvcGVydHkoY29tcG9uZW50SWQpKSB7CiAgICAgICAgICAgIGNvbXBvbmVudCA9IGZyYW1lLmNvbXBvbmVudHNbY29tcG9uZW50SWRdOwogICAgICAgICAgICB2YXIgYmxvY2tzUGVyTGluZSA9IE1hdGguY2VpbChNYXRoLmNlaWwoZnJhbWUuc2FtcGxlc1BlckxpbmUgLyA4KSAqIGNvbXBvbmVudC5oIC8gbWF4SCk7CiAgICAgICAgICAgIHZhciBibG9ja3NQZXJDb2x1bW4gPSBNYXRoLmNlaWwoTWF0aC5jZWlsKGZyYW1lLnNjYW5MaW5lcyAvIDgpICogY29tcG9uZW50LnYgLyBtYXhWKTsKICAgICAgICAgICAgdmFyIGJsb2Nrc1BlckxpbmVGb3JNY3UgPSBtY3VzUGVyTGluZSAqIGNvbXBvbmVudC5oOwogICAgICAgICAgICB2YXIgYmxvY2tzUGVyQ29sdW1uRm9yTWN1ID0gbWN1c1BlckNvbHVtbiAqIGNvbXBvbmVudC52OwogICAgICAgICAgICB2YXIgYmxvY2tzVG9BbGxvY2F0ZSA9IGJsb2Nrc1BlckNvbHVtbkZvck1jdSAqIGJsb2Nrc1BlckxpbmVGb3JNY3U7CiAgICAgICAgICAgIHZhciBibG9ja3MgPSBbXTsKICAgICAgICAgICAgcmVxdWVzdE1lbW9yeUFsbG9jYXRpb24oYmxvY2tzVG9BbGxvY2F0ZSAqIDI1Nik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmxvY2tzUGVyQ29sdW1uRm9yTWN1OyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcm93ID0gW107CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBibG9ja3NQZXJMaW5lRm9yTWN1OyBqKyspCiAgICAgICAgICAgICAgICByb3cucHVzaChuZXcgSW50MzJBcnJheSg2NCkpOwogICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKHJvdyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcG9uZW50LmJsb2Nrc1BlckxpbmUgPSBibG9ja3NQZXJMaW5lOwogICAgICAgICAgICBjb21wb25lbnQuYmxvY2tzUGVyQ29sdW1uID0gYmxvY2tzUGVyQ29sdW1uOwogICAgICAgICAgICBjb21wb25lbnQuYmxvY2tzID0gYmxvY2tzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmcmFtZS5tYXhIID0gbWF4SDsKICAgICAgICBmcmFtZS5tYXhWID0gbWF4VjsKICAgICAgICBmcmFtZS5tY3VzUGVyTGluZSA9IG1jdXNQZXJMaW5lOwogICAgICAgIGZyYW1lLm1jdXNQZXJDb2x1bW4gPSBtY3VzUGVyQ29sdW1uOwogICAgICB9CiAgICAgIHZhciBqZmlmID0gbnVsbDsKICAgICAgdmFyIGFkb2JlID0gbnVsbDsKICAgICAgdmFyIHBpeGVscyA9IG51bGw7CiAgICAgIHZhciBmcmFtZSwgcmVzZXRJbnRlcnZhbDsKICAgICAgdmFyIHF1YW50aXphdGlvblRhYmxlcyA9IFtdLCBmcmFtZXMgPSBbXTsKICAgICAgdmFyIGh1ZmZtYW5UYWJsZXNBQyA9IFtdLCBodWZmbWFuVGFibGVzREMgPSBbXTsKICAgICAgdmFyIGZpbGVNYXJrZXIgPSByZWFkVWludDE2KCk7CiAgICAgIHZhciBtYWxmb3JtZWREYXRhT2Zmc2V0ID0gLTE7CiAgICAgIHRoaXMuY29tbWVudHMgPSBbXTsKICAgICAgaWYgKGZpbGVNYXJrZXIgIT0gMHhGRkQ4KSB7IC8vIFNPSSAoU3RhcnQgb2YgSW1hZ2UpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTT0kgbm90IGZvdW5kIik7CiAgICAgIH0KICAgICAgZmlsZU1hcmtlciA9IHJlYWRVaW50MTYoKTsKICAgICAgd2hpbGUgKGZpbGVNYXJrZXIgIT0gMHhGRkQ5KSB7IC8vIEVPSSAoRW5kIG9mIGltYWdlKQogICAgICAgIHZhciBpLCBqLCBsOwogICAgICAgIHN3aXRjaCAoZmlsZU1hcmtlcikgewogICAgICAgICAgY2FzZSAweEZGMDA6IGJyZWFrOwogICAgICAgICAgY2FzZSAweEZGRTA6IC8vIEFQUDAgKEFwcGxpY2F0aW9uIFNwZWNpZmljKQogICAgICAgICAgY2FzZSAweEZGRTE6IC8vIEFQUDEKICAgICAgICAgIGNhc2UgMHhGRkUyOiAvLyBBUFAyCiAgICAgICAgICBjYXNlIDB4RkZFMzogLy8gQVBQMwogICAgICAgICAgY2FzZSAweEZGRTQ6IC8vIEFQUDQKICAgICAgICAgIGNhc2UgMHhGRkU1OiAvLyBBUFA1CiAgICAgICAgICBjYXNlIDB4RkZFNjogLy8gQVBQNgogICAgICAgICAgY2FzZSAweEZGRTc6IC8vIEFQUDcKICAgICAgICAgIGNhc2UgMHhGRkU4OiAvLyBBUFA4CiAgICAgICAgICBjYXNlIDB4RkZFOTogLy8gQVBQOQogICAgICAgICAgY2FzZSAweEZGRUE6IC8vIEFQUDEwCiAgICAgICAgICBjYXNlIDB4RkZFQjogLy8gQVBQMTEKICAgICAgICAgIGNhc2UgMHhGRkVDOiAvLyBBUFAxMgogICAgICAgICAgY2FzZSAweEZGRUQ6IC8vIEFQUDEzCiAgICAgICAgICBjYXNlIDB4RkZFRTogLy8gQVBQMTQKICAgICAgICAgIGNhc2UgMHhGRkVGOiAvLyBBUFAxNQogICAgICAgICAgY2FzZSAweEZGRkU6IC8vIENPTSAoQ29tbWVudCkKICAgICAgICAgICAgdmFyIGFwcERhdGEgPSByZWFkRGF0YUJsb2NrKCk7CiAgICAgICAgICAgIGlmIChmaWxlTWFya2VyID09PSAweEZGRkUpIHsKICAgICAgICAgICAgICB2YXIgY29tbWVudCA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgYXBwRGF0YSk7CiAgICAgICAgICAgICAgdGhpcy5jb21tZW50cy5wdXNoKGNvbW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWxlTWFya2VyID09PSAweEZGRTApIHsKICAgICAgICAgICAgICBpZiAoYXBwRGF0YVswXSA9PT0gMHg0QSAmJiBhcHBEYXRhWzFdID09PSAweDQ2ICYmIGFwcERhdGFbMl0gPT09IDB4NDkgJiYKICAgICAgICAgICAgICAgIGFwcERhdGFbM10gPT09IDB4NDYgJiYgYXBwRGF0YVs0XSA9PT0gMCkgeyAvLyAnSkZJRlx4MDAnCiAgICAgICAgICAgICAgICBqZmlmID0gewogICAgICAgICAgICAgICAgICB2ZXJzaW9uOiB7IG1ham9yOiBhcHBEYXRhWzVdLCBtaW5vcjogYXBwRGF0YVs2XSB9LAogICAgICAgICAgICAgICAgICBkZW5zaXR5VW5pdHM6IGFwcERhdGFbN10sCiAgICAgICAgICAgICAgICAgIHhEZW5zaXR5OiAoYXBwRGF0YVs4XSA8PCA4KSB8IGFwcERhdGFbOV0sCiAgICAgICAgICAgICAgICAgIHlEZW5zaXR5OiAoYXBwRGF0YVsxMF0gPDwgOCkgfCBhcHBEYXRhWzExXSwKICAgICAgICAgICAgICAgICAgdGh1bWJXaWR0aDogYXBwRGF0YVsxMl0sCiAgICAgICAgICAgICAgICAgIHRodW1iSGVpZ2h0OiBhcHBEYXRhWzEzXSwKICAgICAgICAgICAgICAgICAgdGh1bWJEYXRhOiBhcHBEYXRhLnN1YmFycmF5KDE0LCAxNCArIDMgKiBhcHBEYXRhWzEyXSAqIGFwcERhdGFbMTNdKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpbGVNYXJrZXIgPT09IDB4RkZFMSkgewogICAgICAgICAgICAgIGlmIChhcHBEYXRhWzBdID09PSAweDQ1ICYmCiAgICAgICAgICAgICAgICBhcHBEYXRhWzFdID09PSAweDc4ICYmCiAgICAgICAgICAgICAgICBhcHBEYXRhWzJdID09PSAweDY5ICYmCiAgICAgICAgICAgICAgICBhcHBEYXRhWzNdID09PSAweDY2ICYmCiAgICAgICAgICAgICAgICBhcHBEYXRhWzRdID09PSAwKSB7IC8vICdFWElGXHgwMCcKICAgICAgICAgICAgICAgIHRoaXMuZXhpZkJ1ZmZlciA9IGFwcERhdGEuc3ViYXJyYXkoNSwgYXBwRGF0YS5sZW5ndGgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlsZU1hcmtlciA9PT0gMHhGRkVFKSB7CiAgICAgICAgICAgICAgaWYgKGFwcERhdGFbMF0gPT09IDB4NDEgJiYgYXBwRGF0YVsxXSA9PT0gMHg2NCAmJiBhcHBEYXRhWzJdID09PSAweDZGICYmCiAgICAgICAgICAgICAgICBhcHBEYXRhWzNdID09PSAweDYyICYmIGFwcERhdGFbNF0gPT09IDB4NjUgJiYgYXBwRGF0YVs1XSA9PT0gMCkgeyAvLyAnQWRvYmVceDAwJwogICAgICAgICAgICAgICAgYWRvYmUgPSB7CiAgICAgICAgICAgICAgICAgIHZlcnNpb246IGFwcERhdGFbNl0sCiAgICAgICAgICAgICAgICAgIGZsYWdzMDogKGFwcERhdGFbN10gPDwgOCkgfCBhcHBEYXRhWzhdLAogICAgICAgICAgICAgICAgICBmbGFnczE6IChhcHBEYXRhWzldIDw8IDgpIHwgYXBwRGF0YVsxMF0sCiAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybUNvZGU6IGFwcERhdGFbMTFdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMHhGRkRCOiAvLyBEUVQgKERlZmluZSBRdWFudGl6YXRpb24gVGFibGVzKQogICAgICAgICAgICB2YXIgcXVhbnRpemF0aW9uVGFibGVzTGVuZ3RoID0gcmVhZFVpbnQxNigpOwogICAgICAgICAgICB2YXIgcXVhbnRpemF0aW9uVGFibGVzRW5kID0gcXVhbnRpemF0aW9uVGFibGVzTGVuZ3RoICsgb2Zmc2V0IC0gMjsKICAgICAgICAgICAgd2hpbGUgKG9mZnNldCA8IHF1YW50aXphdGlvblRhYmxlc0VuZCkgewogICAgICAgICAgICAgIHZhciBxdWFudGl6YXRpb25UYWJsZVNwZWMgPSBkYXRhW29mZnNldCsrXTsKICAgICAgICAgICAgICByZXF1ZXN0TWVtb3J5QWxsb2NhdGlvbig2NCAqIDQpOwogICAgICAgICAgICAgIHZhciB0YWJsZURhdGEgPSBuZXcgSW50MzJBcnJheSg2NCk7CiAgICAgICAgICAgICAgaWYgKChxdWFudGl6YXRpb25UYWJsZVNwZWMgPj4gNCkgPT09IDApIHsgLy8gOCBiaXQgdmFsdWVzCiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNjQ7IGorKykgewogICAgICAgICAgICAgICAgICB2YXIgeiA9IGRjdFppZ1phZ1tqXTsKICAgICAgICAgICAgICAgICAgdGFibGVEYXRhW3pdID0gZGF0YVtvZmZzZXQrK107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgocXVhbnRpemF0aW9uVGFibGVTcGVjID4+IDQpID09PSAxKSB7IC8vMTYgYml0CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNjQ7IGorKykgewogICAgICAgICAgICAgICAgICB2YXIgeiA9IGRjdFppZ1phZ1tqXTsKICAgICAgICAgICAgICAgICAgdGFibGVEYXRhW3pdID0gcmVhZFVpbnQxNigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEUVQ6IGludmFsaWQgdGFibGUgc3BlYyIpOwogICAgICAgICAgICAgIHF1YW50aXphdGlvblRhYmxlc1txdWFudGl6YXRpb25UYWJsZVNwZWMgJiAxNV0gPSB0YWJsZURhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDB4RkZDMDogLy8gU09GMCAoU3RhcnQgb2YgRnJhbWUsIEJhc2VsaW5lIERDVCkKICAgICAgICAgIGNhc2UgMHhGRkMxOiAvLyBTT0YxIChTdGFydCBvZiBGcmFtZSwgRXh0ZW5kZWQgRENUKQogICAgICAgICAgY2FzZSAweEZGQzI6IC8vIFNPRjIgKFN0YXJ0IG9mIEZyYW1lLCBQcm9ncmVzc2l2ZSBEQ1QpCiAgICAgICAgICAgIHJlYWRVaW50MTYoKTsgLy8gc2tpcCBkYXRhIGxlbmd0aAogICAgICAgICAgICBmcmFtZSA9IHt9OwogICAgICAgICAgICBmcmFtZS5leHRlbmRlZCA9IChmaWxlTWFya2VyID09PSAweEZGQzEpOwogICAgICAgICAgICBmcmFtZS5wcm9ncmVzc2l2ZSA9IChmaWxlTWFya2VyID09PSAweEZGQzIpOwogICAgICAgICAgICBmcmFtZS5wcmVjaXNpb24gPSBkYXRhW29mZnNldCsrXTsKICAgICAgICAgICAgZnJhbWUuc2NhbkxpbmVzID0gcmVhZFVpbnQxNigpOwogICAgICAgICAgICBmcmFtZS5zYW1wbGVzUGVyTGluZSA9IHJlYWRVaW50MTYoKTsKICAgICAgICAgICAgZnJhbWUuY29tcG9uZW50cyA9IHt9OwogICAgICAgICAgICBmcmFtZS5jb21wb25lbnRzT3JkZXIgPSBbXTsKICAgICAgICAgICAgdmFyIHBpeGVsc0luRnJhbWUgPSBmcmFtZS5zY2FuTGluZXMgKiBmcmFtZS5zYW1wbGVzUGVyTGluZTsKICAgICAgICAgICAgaWYgKHBpeGVsc0luRnJhbWUgPiBtYXhSZXNvbHV0aW9uSW5QaXhlbHMpIHsKICAgICAgICAgICAgICB2YXIgZXhjZWVkZWRBbW91bnQgPSBNYXRoLmNlaWwoKHBpeGVsc0luRnJhbWUgLSBtYXhSZXNvbHV0aW9uSW5QaXhlbHMpIC8gMWU2KTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG1heFJlc29sdXRpb25Jbk1QIGxpbWl0IGV4Y2VlZGVkIGJ5ICR7ZXhjZWVkZWRBbW91bnR9TVBgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50c0NvdW50ID0gZGF0YVtvZmZzZXQrK10sIGNvbXBvbmVudElkOwogICAgICAgICAgICB2YXIgbWF4SCA9IDAsIG1heFYgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcG9uZW50c0NvdW50OyBpKyspIHsKICAgICAgICAgICAgICBjb21wb25lbnRJZCA9IGRhdGFbb2Zmc2V0XTsKICAgICAgICAgICAgICB2YXIgaCA9IGRhdGFbb2Zmc2V0ICsgMV0gPj4gNDsKICAgICAgICAgICAgICB2YXIgdiA9IGRhdGFbb2Zmc2V0ICsgMV0gJiAxNTsKICAgICAgICAgICAgICB2YXIgcUlkID0gZGF0YVtvZmZzZXQgKyAyXTsKICAgICAgICAgICAgICBmcmFtZS5jb21wb25lbnRzT3JkZXIucHVzaChjb21wb25lbnRJZCk7CiAgICAgICAgICAgICAgZnJhbWUuY29tcG9uZW50c1tjb21wb25lbnRJZF0gPSB7CiAgICAgICAgICAgICAgICBoOiBoLAogICAgICAgICAgICAgICAgdjogdiwKICAgICAgICAgICAgICAgIHF1YW50aXphdGlvbklkeDogcUlkCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBvZmZzZXQgKz0gMzsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcmVwYXJlQ29tcG9uZW50cyhmcmFtZSk7CiAgICAgICAgICAgIGZyYW1lcy5wdXNoKGZyYW1lKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDB4RkZDNDogLy8gREhUIChEZWZpbmUgSHVmZm1hbiBUYWJsZXMpCiAgICAgICAgICAgIHZhciBodWZmbWFuTGVuZ3RoID0gcmVhZFVpbnQxNigpOwogICAgICAgICAgICBmb3IgKGkgPSAyOyBpIDwgaHVmZm1hbkxlbmd0aDspIHsKICAgICAgICAgICAgICB2YXIgaHVmZm1hblRhYmxlU3BlYyA9IGRhdGFbb2Zmc2V0KytdOwogICAgICAgICAgICAgIHZhciBjb2RlTGVuZ3RocyA9IG5ldyBVaW50OEFycmF5KDE2KTsKICAgICAgICAgICAgICB2YXIgY29kZUxlbmd0aFN1bSA9IDA7CiAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IDE2OyBqKyssIG9mZnNldCsrKSB7CiAgICAgICAgICAgICAgICBjb2RlTGVuZ3RoU3VtICs9IChjb2RlTGVuZ3Roc1tqXSA9IGRhdGFbb2Zmc2V0XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RNZW1vcnlBbGxvY2F0aW9uKDE2ICsgY29kZUxlbmd0aFN1bSk7CiAgICAgICAgICAgICAgdmFyIGh1ZmZtYW5WYWx1ZXMgPSBuZXcgVWludDhBcnJheShjb2RlTGVuZ3RoU3VtKTsKICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgY29kZUxlbmd0aFN1bTsgaisrLCBvZmZzZXQrKykKICAgICAgICAgICAgICAgIGh1ZmZtYW5WYWx1ZXNbal0gPSBkYXRhW29mZnNldF07CiAgICAgICAgICAgICAgaSArPSAxNyArIGNvZGVMZW5ndGhTdW07CiAgICAgICAgICAgICAgKChodWZmbWFuVGFibGVTcGVjID4+IDQpID09PSAwID8KICAgICAgICAgICAgICAgIGh1ZmZtYW5UYWJsZXNEQyA6IGh1ZmZtYW5UYWJsZXNBQylbaHVmZm1hblRhYmxlU3BlYyAmIDE1XSA9CiAgICAgICAgICAgICAgICBidWlsZEh1ZmZtYW5UYWJsZShjb2RlTGVuZ3RocywgaHVmZm1hblZhbHVlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDB4RkZERDogLy8gRFJJIChEZWZpbmUgUmVzdGFydCBJbnRlcnZhbCkKICAgICAgICAgICAgcmVhZFVpbnQxNigpOyAvLyBza2lwIGRhdGEgbGVuZ3RoCiAgICAgICAgICAgIHJlc2V0SW50ZXJ2YWwgPSByZWFkVWludDE2KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAweEZGREM6IC8vIE51bWJlciBvZiBMaW5lcyBtYXJrZXIKICAgICAgICAgICAgcmVhZFVpbnQxNigpIC8vIHNraXAgZGF0YSBsZW5ndGgKICAgICAgICAgICAgcmVhZFVpbnQxNigpIC8vIElnbm9yZSB0aGlzIGRhdGEgc2luY2UgaXQgcmVwcmVzZW50cyB0aGUgaW1hZ2UgaGVpZ2h0CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAweEZGREE6IC8vIFNPUyAoU3RhcnQgb2YgU2NhbikKICAgICAgICAgICAgdmFyIHNjYW5MZW5ndGggPSByZWFkVWludDE2KCk7CiAgICAgICAgICAgIHZhciBzZWxlY3RvcnNDb3VudCA9IGRhdGFbb2Zmc2V0KytdOwogICAgICAgICAgICB2YXIgY29tcG9uZW50cyA9IFtdLCBjb21wb25lbnQ7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWxlY3RvcnNDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50ID0gZnJhbWUuY29tcG9uZW50c1tkYXRhW29mZnNldCsrXV07CiAgICAgICAgICAgICAgdmFyIHRhYmxlU3BlYyA9IGRhdGFbb2Zmc2V0KytdOwogICAgICAgICAgICAgIGNvbXBvbmVudC5odWZmbWFuVGFibGVEQyA9IGh1ZmZtYW5UYWJsZXNEQ1t0YWJsZVNwZWMgPj4gNF07CiAgICAgICAgICAgICAgY29tcG9uZW50Lmh1ZmZtYW5UYWJsZUFDID0gaHVmZm1hblRhYmxlc0FDW3RhYmxlU3BlYyAmIDE1XTsKICAgICAgICAgICAgICBjb21wb25lbnRzLnB1c2goY29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3BlY3RyYWxTdGFydCA9IGRhdGFbb2Zmc2V0KytdOwogICAgICAgICAgICB2YXIgc3BlY3RyYWxFbmQgPSBkYXRhW29mZnNldCsrXTsKICAgICAgICAgICAgdmFyIHN1Y2Nlc3NpdmVBcHByb3hpbWF0aW9uID0gZGF0YVtvZmZzZXQrK107CiAgICAgICAgICAgIHZhciBwcm9jZXNzZWQgPSBkZWNvZGVTY2FuKGRhdGEsIG9mZnNldCwKICAgICAgICAgICAgICBmcmFtZSwgY29tcG9uZW50cywgcmVzZXRJbnRlcnZhbCwKICAgICAgICAgICAgICBzcGVjdHJhbFN0YXJ0LCBzcGVjdHJhbEVuZCwKICAgICAgICAgICAgICBzdWNjZXNzaXZlQXBwcm94aW1hdGlvbiA+PiA0LCBzdWNjZXNzaXZlQXBwcm94aW1hdGlvbiAmIDE1LCB0aGlzLm9wdHMpOwogICAgICAgICAgICBvZmZzZXQgKz0gcHJvY2Vzc2VkOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMHhGRkZGOiAvLyBGaWxsIGJ5dGVzCiAgICAgICAgICAgIGlmIChkYXRhW29mZnNldF0gIT09IDB4RkYpIHsgLy8gQXZvaWQgc2tpcHBpbmcgYSB2YWxpZCBtYXJrZXIuCiAgICAgICAgICAgICAgb2Zmc2V0LS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBpZiAoZGF0YVtvZmZzZXQgLSAzXSA9PSAweEZGICYmCiAgICAgICAgICAgICAgZGF0YVtvZmZzZXQgLSAyXSA+PSAweEMwICYmIGRhdGFbb2Zmc2V0IC0gMl0gPD0gMHhGRSkgewogICAgICAgICAgICAgIG9mZnNldCAtPSAzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZpbGVNYXJrZXIgPT09IDB4RTAgfHwgZmlsZU1hcmtlciA9PSAweEUxKSB7CiAgICAgICAgICAgICAgaWYgKG1hbGZvcm1lZERhdGFPZmZzZXQgIT09IC0xKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGZpcnN0IHVua25vd24gSlBFRyBtYXJrZXIgYXQgb2Zmc2V0ICR7bWFsZm9ybWVkRGF0YU9mZnNldC50b1N0cmluZygxNil9LCBzZWNvbmQgdW5rbm93biBKUEVHIG1hcmtlciAke2ZpbGVNYXJrZXIudG9TdHJpbmcoMTYpfSBhdCBvZmZzZXQgJHsob2Zmc2V0IC0gMSkudG9TdHJpbmcoMTYpfWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYWxmb3JtZWREYXRhT2Zmc2V0ID0gb2Zmc2V0IC0gMTsKICAgICAgICAgICAgICBjb25zdCBuZXh0T2Zmc2V0ID0gcmVhZFVpbnQxNigpOwogICAgICAgICAgICAgIGlmIChkYXRhW29mZnNldCArIG5leHRPZmZzZXQgLSAyXSA9PT0gMHhGRikgewogICAgICAgICAgICAgICAgb2Zmc2V0ICs9IG5leHRPZmZzZXQgLSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biBKUEVHIG1hcmtlciAiICsgZmlsZU1hcmtlci50b1N0cmluZygxNikpOwogICAgICAgIH0KICAgICAgICBmaWxlTWFya2VyID0gcmVhZFVpbnQxNigpOwogICAgICB9CiAgICAgIGlmIChmcmFtZXMubGVuZ3RoICE9IDEpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJvbmx5IHNpbmdsZSBmcmFtZSBKUEVHcyBzdXBwb3J0ZWQiKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY3AgPSBmcmFtZXNbaV0uY29tcG9uZW50czsKICAgICAgICBmb3IgKHZhciBqIGluIGNwKSB7CiAgICAgICAgICBjcFtqXS5xdWFudGl6YXRpb25UYWJsZSA9IHF1YW50aXphdGlvblRhYmxlc1tjcFtqXS5xdWFudGl6YXRpb25JZHhdOwogICAgICAgICAgZGVsZXRlIGNwW2pdLnF1YW50aXphdGlvbklkeDsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy53aWR0aCA9IGZyYW1lLnNhbXBsZXNQZXJMaW5lOwogICAgICB0aGlzLmhlaWdodCA9IGZyYW1lLnNjYW5MaW5lczsKICAgICAgdGhpcy5qZmlmID0gamZpZjsKICAgICAgdGhpcy5hZG9iZSA9IGFkb2JlOwogICAgICB0aGlzLmNvbXBvbmVudHMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZS5jb21wb25lbnRzT3JkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY29tcG9uZW50ID0gZnJhbWUuY29tcG9uZW50c1tmcmFtZS5jb21wb25lbnRzT3JkZXJbaV1dOwogICAgICAgIHRoaXMuY29tcG9uZW50cy5wdXNoKHsKICAgICAgICAgIGxpbmVzOiBidWlsZENvbXBvbmVudERhdGEoZnJhbWUsIGNvbXBvbmVudCksCiAgICAgICAgICBzY2FsZVg6IGNvbXBvbmVudC5oIC8gZnJhbWUubWF4SCwKICAgICAgICAgIHNjYWxlWTogY29tcG9uZW50LnYgLyBmcmFtZS5tYXhWCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBnZXREYXRhOiBmdW5jdGlvbiBnZXREYXRhKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgdmFyIHNjYWxlWCA9IHRoaXMud2lkdGggLyB3aWR0aCwgc2NhbGVZID0gdGhpcy5oZWlnaHQgLyBoZWlnaHQ7CiAgICAgIHZhciBjb21wb25lbnQxLCBjb21wb25lbnQyLCBjb21wb25lbnQzLCBjb21wb25lbnQ0OwogICAgICB2YXIgY29tcG9uZW50MUxpbmUsIGNvbXBvbmVudDJMaW5lLCBjb21wb25lbnQzTGluZSwgY29tcG9uZW50NExpbmU7CiAgICAgIHZhciB4LCB5OwogICAgICB2YXIgb2Zmc2V0ID0gMDsKICAgICAgdmFyIFksIENiLCBDciwgSywgQywgTSwgWWUsIFIsIEcsIEI7CiAgICAgIHZhciBjb2xvclRyYW5zZm9ybTsKICAgICAgdmFyIGRhdGFMZW5ndGggPSB3aWR0aCAqIGhlaWdodCAqIHRoaXMuY29tcG9uZW50cy5sZW5ndGg7CiAgICAgIHJlcXVlc3RNZW1vcnlBbGxvY2F0aW9uKGRhdGFMZW5ndGgpOwogICAgICB2YXIgZGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGFMZW5ndGgpOwogICAgICBzd2l0Y2ggKHRoaXMuY29tcG9uZW50cy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBjb21wb25lbnQxID0gdGhpcy5jb21wb25lbnRzWzBdOwogICAgICAgICAgZm9yICh5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7CiAgICAgICAgICAgIGNvbXBvbmVudDFMaW5lID0gY29tcG9uZW50MS5saW5lc1swIHwgKHkgKiBjb21wb25lbnQxLnNjYWxlWSAqIHNjYWxlWSldOwogICAgICAgICAgICBmb3IgKHggPSAwOyB4IDwgd2lkdGg7IHgrKykgewogICAgICAgICAgICAgIFkgPSBjb21wb25lbnQxTGluZVswIHwgKHggKiBjb21wb25lbnQxLnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgIGRhdGFbb2Zmc2V0KytdID0gWTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgY29tcG9uZW50MSA9IHRoaXMuY29tcG9uZW50c1swXTsKICAgICAgICAgIGNvbXBvbmVudDIgPSB0aGlzLmNvbXBvbmVudHNbMV07CiAgICAgICAgICBmb3IgKHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHsKICAgICAgICAgICAgY29tcG9uZW50MUxpbmUgPSBjb21wb25lbnQxLmxpbmVzWzAgfCAoeSAqIGNvbXBvbmVudDEuc2NhbGVZICogc2NhbGVZKV07CiAgICAgICAgICAgIGNvbXBvbmVudDJMaW5lID0gY29tcG9uZW50Mi5saW5lc1swIHwgKHkgKiBjb21wb25lbnQyLnNjYWxlWSAqIHNjYWxlWSldOwogICAgICAgICAgICBmb3IgKHggPSAwOyB4IDwgd2lkdGg7IHgrKykgewogICAgICAgICAgICAgIFkgPSBjb21wb25lbnQxTGluZVswIHwgKHggKiBjb21wb25lbnQxLnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgIGRhdGFbb2Zmc2V0KytdID0gWTsKICAgICAgICAgICAgICBZID0gY29tcG9uZW50MkxpbmVbMCB8ICh4ICogY29tcG9uZW50Mi5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICBkYXRhW29mZnNldCsrXSA9IFk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzoKICAgICAgICAgIGNvbG9yVHJhbnNmb3JtID0gdHJ1ZTsKICAgICAgICAgIGlmICh0aGlzLmFkb2JlICYmIHRoaXMuYWRvYmUudHJhbnNmb3JtQ29kZSkKICAgICAgICAgICAgY29sb3JUcmFuc2Zvcm0gPSB0cnVlOwogICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHRoaXMub3B0cy5jb2xvclRyYW5zZm9ybSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIGNvbG9yVHJhbnNmb3JtID0gISF0aGlzLm9wdHMuY29sb3JUcmFuc2Zvcm07CiAgICAgICAgICBjb21wb25lbnQxID0gdGhpcy5jb21wb25lbnRzWzBdOwogICAgICAgICAgY29tcG9uZW50MiA9IHRoaXMuY29tcG9uZW50c1sxXTsKICAgICAgICAgIGNvbXBvbmVudDMgPSB0aGlzLmNvbXBvbmVudHNbMl07CiAgICAgICAgICBmb3IgKHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHsKICAgICAgICAgICAgY29tcG9uZW50MUxpbmUgPSBjb21wb25lbnQxLmxpbmVzWzAgfCAoeSAqIGNvbXBvbmVudDEuc2NhbGVZICogc2NhbGVZKV07CiAgICAgICAgICAgIGNvbXBvbmVudDJMaW5lID0gY29tcG9uZW50Mi5saW5lc1swIHwgKHkgKiBjb21wb25lbnQyLnNjYWxlWSAqIHNjYWxlWSldOwogICAgICAgICAgICBjb21wb25lbnQzTGluZSA9IGNvbXBvbmVudDMubGluZXNbMCB8ICh5ICogY29tcG9uZW50My5zY2FsZVkgKiBzY2FsZVkpXTsKICAgICAgICAgICAgZm9yICh4ID0gMDsgeCA8IHdpZHRoOyB4KyspIHsKICAgICAgICAgICAgICBpZiAoIWNvbG9yVHJhbnNmb3JtKSB7CiAgICAgICAgICAgICAgICBSID0gY29tcG9uZW50MUxpbmVbMCB8ICh4ICogY29tcG9uZW50MS5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIEcgPSBjb21wb25lbnQyTGluZVswIHwgKHggKiBjb21wb25lbnQyLnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgICAgQiA9IGNvbXBvbmVudDNMaW5lWzAgfCAoeCAqIGNvbXBvbmVudDMuc2NhbGVYICogc2NhbGVYKV07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFkgPSBjb21wb25lbnQxTGluZVswIHwgKHggKiBjb21wb25lbnQxLnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgICAgQ2IgPSBjb21wb25lbnQyTGluZVswIHwgKHggKiBjb21wb25lbnQyLnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgICAgQ3IgPSBjb21wb25lbnQzTGluZVswIHwgKHggKiBjb21wb25lbnQzLnNjYWxlWCAqIHNjYWxlWCldOwoKICAgICAgICAgICAgICAgIFIgPSBjbGFtcFRvOGJpdChZICsgMS40MDIgKiAoQ3IgLSAxMjgpKTsKICAgICAgICAgICAgICAgIEcgPSBjbGFtcFRvOGJpdChZIC0gMC4zNDQxMzYzICogKENiIC0gMTI4KSAtIDAuNzE0MTM2MzYgKiAoQ3IgLSAxMjgpKTsKICAgICAgICAgICAgICAgIEIgPSBjbGFtcFRvOGJpdChZICsgMS43NzIgKiAoQ2IgLSAxMjgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YVtvZmZzZXQrK10gPSBSOwogICAgICAgICAgICAgIGRhdGFbb2Zmc2V0KytdID0gRzsKICAgICAgICAgICAgICBkYXRhW29mZnNldCsrXSA9IEI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNDoKICAgICAgICAgIGlmICghdGhpcy5hZG9iZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBjb2xvciBtb2RlICg0IGNvbXBvbmVudHMpJyk7CiAgICAgICAgICBjb2xvclRyYW5zZm9ybSA9IGZhbHNlOwogICAgICAgICAgaWYgKHRoaXMuYWRvYmUgJiYgdGhpcy5hZG9iZS50cmFuc2Zvcm1Db2RlKQogICAgICAgICAgICBjb2xvclRyYW5zZm9ybSA9IHRydWU7CiAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgdGhpcy5vcHRzLmNvbG9yVHJhbnNmb3JtICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgY29sb3JUcmFuc2Zvcm0gPSAhIXRoaXMub3B0cy5jb2xvclRyYW5zZm9ybTsKICAgICAgICAgIGNvbXBvbmVudDEgPSB0aGlzLmNvbXBvbmVudHNbMF07CiAgICAgICAgICBjb21wb25lbnQyID0gdGhpcy5jb21wb25lbnRzWzFdOwogICAgICAgICAgY29tcG9uZW50MyA9IHRoaXMuY29tcG9uZW50c1syXTsKICAgICAgICAgIGNvbXBvbmVudDQgPSB0aGlzLmNvbXBvbmVudHNbM107CiAgICAgICAgICBmb3IgKHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHsKICAgICAgICAgICAgY29tcG9uZW50MUxpbmUgPSBjb21wb25lbnQxLmxpbmVzWzAgfCAoeSAqIGNvbXBvbmVudDEuc2NhbGVZICogc2NhbGVZKV07CiAgICAgICAgICAgIGNvbXBvbmVudDJMaW5lID0gY29tcG9uZW50Mi5saW5lc1swIHwgKHkgKiBjb21wb25lbnQyLnNjYWxlWSAqIHNjYWxlWSldOwogICAgICAgICAgICBjb21wb25lbnQzTGluZSA9IGNvbXBvbmVudDMubGluZXNbMCB8ICh5ICogY29tcG9uZW50My5zY2FsZVkgKiBzY2FsZVkpXTsKICAgICAgICAgICAgY29tcG9uZW50NExpbmUgPSBjb21wb25lbnQ0LmxpbmVzWzAgfCAoeSAqIGNvbXBvbmVudDQuc2NhbGVZICogc2NhbGVZKV07CiAgICAgICAgICAgIGZvciAoeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7CiAgICAgICAgICAgICAgaWYgKCFjb2xvclRyYW5zZm9ybSkgewogICAgICAgICAgICAgICAgQyA9IGNvbXBvbmVudDFMaW5lWzAgfCAoeCAqIGNvbXBvbmVudDEuc2NhbGVYICogc2NhbGVYKV07CiAgICAgICAgICAgICAgICBNID0gY29tcG9uZW50MkxpbmVbMCB8ICh4ICogY29tcG9uZW50Mi5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIFllID0gY29tcG9uZW50M0xpbmVbMCB8ICh4ICogY29tcG9uZW50My5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIEsgPSBjb21wb25lbnQ0TGluZVswIHwgKHggKiBjb21wb25lbnQ0LnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBZID0gY29tcG9uZW50MUxpbmVbMCB8ICh4ICogY29tcG9uZW50MS5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIENiID0gY29tcG9uZW50MkxpbmVbMCB8ICh4ICogY29tcG9uZW50Mi5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIENyID0gY29tcG9uZW50M0xpbmVbMCB8ICh4ICogY29tcG9uZW50My5zY2FsZVggKiBzY2FsZVgpXTsKICAgICAgICAgICAgICAgIEsgPSBjb21wb25lbnQ0TGluZVswIHwgKHggKiBjb21wb25lbnQ0LnNjYWxlWCAqIHNjYWxlWCldOwogICAgICAgICAgICAgICAgQyA9IDI1NSAtIGNsYW1wVG84Yml0KFkgKyAxLjQwMiAqIChDciAtIDEyOCkpOwogICAgICAgICAgICAgICAgTSA9IDI1NSAtIGNsYW1wVG84Yml0KFkgLSAwLjM0NDEzNjMgKiAoQ2IgLSAxMjgpIC0gMC43MTQxMzYzNiAqIChDciAtIDEyOCkpOwogICAgICAgICAgICAgICAgWWUgPSAyNTUgLSBjbGFtcFRvOGJpdChZICsgMS43NzIgKiAoQ2IgLSAxMjgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YVtvZmZzZXQrK10gPSAyNTUgLSBDOwogICAgICAgICAgICAgIGRhdGFbb2Zmc2V0KytdID0gMjU1IC0gTTsKICAgICAgICAgICAgICBkYXRhW29mZnNldCsrXSA9IDI1NSAtIFllOwogICAgICAgICAgICAgIGRhdGFbb2Zmc2V0KytdID0gMjU1IC0gSzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5zdXBwb3J0ZWQgY29sb3IgbW9kZScpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwKICAgIGNvcHlUb0ltYWdlRGF0YTogZnVuY3Rpb24gY29weVRvSW1hZ2VEYXRhKGltYWdlRGF0YSwgZm9ybWF0QXNSR0JBKSB7CiAgICAgIHZhciB3aWR0aCA9IGltYWdlRGF0YS53aWR0aCwgaGVpZ2h0ID0gaW1hZ2VEYXRhLmhlaWdodDsKICAgICAgdmFyIGltYWdlRGF0YUFycmF5ID0gaW1hZ2VEYXRhLmRhdGE7CiAgICAgIHZhciBkYXRhID0gdGhpcy5nZXREYXRhKHdpZHRoLCBoZWlnaHQpOwogICAgICB2YXIgaSA9IDAsIGogPSAwLCB4LCB5OwogICAgICB2YXIgWSwgSywgQywgTSwgUiwgRywgQjsKICAgICAgc3dpdGNoICh0aGlzLmNvbXBvbmVudHMubGVuZ3RoKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgZm9yICh5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7CiAgICAgICAgICAgIGZvciAoeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7CiAgICAgICAgICAgICAgWSA9IGRhdGFbaSsrXTsKICAgICAgICAgICAgICBpbWFnZURhdGFBcnJheVtqKytdID0gWTsKICAgICAgICAgICAgICBpbWFnZURhdGFBcnJheVtqKytdID0gWTsKICAgICAgICAgICAgICBpbWFnZURhdGFBcnJheVtqKytdID0gWTsKICAgICAgICAgICAgICBpZiAoZm9ybWF0QXNSR0JBKSB7CiAgICAgICAgICAgICAgICBpbWFnZURhdGFBcnJheVtqKytdID0gMjU1OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgZm9yICh5ID0gMDsgeSA8IGhlaWdodDsgeSsrKSB7CiAgICAgICAgICAgIGZvciAoeCA9IDA7IHggPCB3aWR0aDsgeCsrKSB7CiAgICAgICAgICAgICAgUiA9IGRhdGFbaSsrXTsKICAgICAgICAgICAgICBHID0gZGF0YVtpKytdOwogICAgICAgICAgICAgIEIgPSBkYXRhW2krK107CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IFI7CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IEc7CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IEI7CiAgICAgICAgICAgICAgaWYgKGZvcm1hdEFzUkdCQSkgewogICAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IDI1NTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNDoKICAgICAgICAgIGZvciAoeSA9IDA7IHkgPCBoZWlnaHQ7IHkrKykgewogICAgICAgICAgICBmb3IgKHggPSAwOyB4IDwgd2lkdGg7IHgrKykgewogICAgICAgICAgICAgIEMgPSBkYXRhW2krK107CiAgICAgICAgICAgICAgTSA9IGRhdGFbaSsrXTsKICAgICAgICAgICAgICBZID0gZGF0YVtpKytdOwogICAgICAgICAgICAgIEsgPSBkYXRhW2krK107CiAgICAgICAgICAgICAgUiA9IDI1NSAtIGNsYW1wVG84Yml0KEMgKiAoMSAtIEsgLyAyNTUpICsgSyk7CiAgICAgICAgICAgICAgRyA9IDI1NSAtIGNsYW1wVG84Yml0KE0gKiAoMSAtIEsgLyAyNTUpICsgSyk7CiAgICAgICAgICAgICAgQiA9IDI1NSAtIGNsYW1wVG84Yml0KFkgKiAoMSAtIEsgLyAyNTUpICsgSyk7CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IFI7CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IEc7CiAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IEI7CiAgICAgICAgICAgICAgaWYgKGZvcm1hdEFzUkdCQSkgewogICAgICAgICAgICAgICAgaW1hZ2VEYXRhQXJyYXlbaisrXSA9IDI1NTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIGNvbG9yIG1vZGUnKTsKICAgICAgfQogICAgfQogIH07CiAgdmFyIHRvdGFsQnl0ZXNBbGxvY2F0ZWQgPSAwOwogIHZhciBtYXhNZW1vcnlVc2FnZUJ5dGVzID0gMDsKICBmdW5jdGlvbiByZXF1ZXN0TWVtb3J5QWxsb2NhdGlvbihpbmNyZWFzZUFtb3VudCA9IDApIHsKICAgIHZhciB0b3RhbE1lbW9yeUltcGFjdEJ5dGVzID0gdG90YWxCeXRlc0FsbG9jYXRlZCArIGluY3JlYXNlQW1vdW50OwogICAgaWYgKHRvdGFsTWVtb3J5SW1wYWN0Qnl0ZXMgPiBtYXhNZW1vcnlVc2FnZUJ5dGVzKSB7CiAgICAgIHZhciBleGNlZWRlZEFtb3VudCA9IE1hdGguY2VpbCgodG90YWxNZW1vcnlJbXBhY3RCeXRlcyAtIG1heE1lbW9yeVVzYWdlQnl0ZXMpIC8gMTAyNCAvIDEwMjQpOwogICAgICB0aHJvdyBuZXcgRXJyb3IoYG1heE1lbW9yeVVzYWdlSW5NQiBsaW1pdCBleGNlZWRlZCBieSBhdCBsZWFzdCAke2V4Y2VlZGVkQW1vdW50fU1CYCk7CiAgICB9CiAgICB0b3RhbEJ5dGVzQWxsb2NhdGVkID0gdG90YWxNZW1vcnlJbXBhY3RCeXRlczsKICB9CiAgY29uc3RydWN0b3IucmVzZXRNYXhNZW1vcnlVc2FnZSA9IGZ1bmN0aW9uIChtYXhNZW1vcnlVc2FnZUJ5dGVzXykgewogICAgdG90YWxCeXRlc0FsbG9jYXRlZCA9IDA7CiAgICBtYXhNZW1vcnlVc2FnZUJ5dGVzID0gbWF4TWVtb3J5VXNhZ2VCeXRlc187CiAgfTsKICBjb25zdHJ1Y3Rvci5nZXRCeXRlc0FsbG9jYXRlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0b3RhbEJ5dGVzQWxsb2NhdGVkOwogIH07CiAgY29uc3RydWN0b3IucmVxdWVzdE1lbW9yeUFsbG9jYXRpb24gPSByZXF1ZXN0TWVtb3J5QWxsb2NhdGlvbjsKICByZXR1cm4gY29uc3RydWN0b3I7Cn0pKCk7CnNlbGZbJ2pwZWctanMnXSA9IHNlbGZbJ2pwZWctanMnXSB8fCB7fTsKc2VsZlsnanBlZy1qcyddLmRlY29kZSA9IGZ1bmN0aW9uIChqcGVnRGF0YSwgdXNlck9wdHMgPSB7fSkgewogIHZhciBkZWZhdWx0T3B0cyA9IHsKICAgIGNvbG9yVHJhbnNmb3JtOiB1bmRlZmluZWQsCiAgICB1c2VUQXJyYXk6IGZhbHNlLAogICAgZm9ybWF0QXNSR0JBOiB0cnVlLAogICAgdG9sZXJhbnREZWNvZGluZzogdHJ1ZSwKICAgIG1heFJlc29sdXRpb25Jbk1QOiAxMDAsIC8vIERvbid0IGRlY29kZSBtb3JlIHRoYW4gMTAwIG1lZ2FwaXhlbHMKICAgIG1heE1lbW9yeVVzYWdlSW5NQjogNTEyLCAvLyBEb24ndCBkZWNvZGUgaWYgbWVtb3J5IGZvb3RwcmludCBpcyBtb3JlIHRoYW4gNTEyTUIKICB9OwogIHZhciBvcHRzID0geyAuLi5kZWZhdWx0T3B0cywgLi4udXNlck9wdHMgfTsKICB2YXIgYXJyID0gbmV3IFVpbnQ4QXJyYXkoanBlZ0RhdGEpOwogIHZhciBkZWNvZGVyID0gbmV3IEpwZWdJbWFnZSgpOwogIGRlY29kZXIub3B0cyA9IG9wdHM7CiAgSnBlZ0ltYWdlLnJlc2V0TWF4TWVtb3J5VXNhZ2Uob3B0cy5tYXhNZW1vcnlVc2FnZUluTUIgKiAxMDI0ICogMTAyNCk7CiAgZGVjb2Rlci5wYXJzZShhcnIpOwogIHZhciBjaGFubmVscyA9IChvcHRzLmZvcm1hdEFzUkdCQSkgPyA0IDogMzsKICB2YXIgYnl0ZXNOZWVkZWQgPSBkZWNvZGVyLndpZHRoICogZGVjb2Rlci5oZWlnaHQgKiBjaGFubmVsczsKICB0cnkgewogICAgSnBlZ0ltYWdlLnJlcXVlc3RNZW1vcnlBbGxvY2F0aW9uKGJ5dGVzTmVlZGVkKTsKICAgIHZhciBpbWFnZSA9IHsKICAgICAgd2lkdGg6IGRlY29kZXIud2lkdGgsCiAgICAgIGhlaWdodDogZGVjb2Rlci5oZWlnaHQsCiAgICAgIGV4aWZCdWZmZXI6IGRlY29kZXIuZXhpZkJ1ZmZlciwKICAgICAgZGF0YTogb3B0cy51c2VUQXJyYXkgPwogICAgICAgIG5ldyBVaW50OEFycmF5KGJ5dGVzTmVlZGVkKSA6CiAgICAgICAgQnVmZmVyLmFsbG9jKGJ5dGVzTmVlZGVkKQogICAgfTsKICAgIGlmIChkZWNvZGVyLmNvbW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgaW1hZ2VbImNvbW1lbnRzIl0gPSBkZWNvZGVyLmNvbW1lbnRzOwogICAgfQogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKGVyciBpbnN0YW5jZW9mIFJhbmdlRXJyb3IpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgYWxsb2NhdGUgZW5vdWdoIG1lbW9yeSBmb3IgdGhlIGltYWdlLiAiICsKICAgICAgICAiUmVxdWlyZWQ6ICIgKyBieXRlc05lZWRlZCk7CiAgICB9CiAgICBpZiAoZXJyIGluc3RhbmNlb2YgUmVmZXJlbmNlRXJyb3IpIHsKICAgICAgaWYgKGVyci5tZXNzYWdlID09PSAiQnVmZmVyIGlzIG5vdCBkZWZpbmVkIikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQnVmZmVyIGlzIG5vdCBnbG9iYWxseSBkZWZpbmVkIGluIHRoaXMgZW52aXJvbm1lbnQuICIgKwogICAgICAgICAgIkNvbnNpZGVyIHNldHRpbmcgdXNlVEFycmF5IHRvIHRydWUiKTsKICAgICAgfQogICAgfQogICAgdGhyb3cgZXJyOwogIH0KICBkZWNvZGVyLmNvcHlUb0ltYWdlRGF0YShpbWFnZSwgb3B0cy5mb3JtYXRBc1JHQkEpOwogIHJldHVybiBpbWFnZTsKfQoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gKGUpIHsKCUJsb2NrSGFzaC5ibG9ja2hhc2goZS5kYXRhLmltZywgMTYsIDIsIChlcnIsIGhhc2gpID0+IHsKICAgIHNlbGYucG9zdE1lc3NhZ2UoeyBpZDogZS5kYXRhLmlkLCBlcnI6IGVyciwgaGFzaDogaGFzaCB9KQogIH0pCn0p');
        worker.onmessage = (e) => {
            if (e.data.error) {
                rejects.get(e.data.id)(e.data.error);
                resolves.delete(e.data.id);
                rejects.delete(e.data.id);
            }
            else {
                resolves.get(e.data.id)(e.data.hash);
                resolves.delete(e.data.id);
                rejects.delete(e.data.id)
            }
        };
        return (img) => {
            const msg = {
                id: globalId++,
                img: img
            };
            return new Promise((resolve, reject) => {
                resolves.set(msg.id, resolve);
                rejects.set(msg.id, reject);
                worker.postMessage(msg);
            });
        };
    })();
    function fetchAndHashImage(src, then) {
        GM_xmlhttpRequest({
            method: 'GET',
            url: src,
            responseType: 'arraybuffer',
            onload: (response) => {
                getHash(response.response).then(then);
            }
        });
    }
    class MenuOption {
        constructor(init) {
            var _a;
            this.div = document.createElement('div');
            this.checkbox = document.createElement('input');
            this.div.style.marginBottom = '10px';
            this.div.innerText = init.text || '';
            this.checkbox.type = 'checkbox';
            this.checkbox.checked = (_a = init.checked) !== null && _a !== void 0 ? _a : false;
            this.checkbox.classList.add('option_style_6');
            if (init.onclick) {
                this.checkbox.addEventListener('click', init.onclick);
            }
            this.onsave = init.onsave;
            this.onsavecancelled = init.onsavecancelled;
            this.div.insertBefore(this.checkbox, this.div.childNodes[0]);
        }
        static insert(...options) {
            let prev = this.head;
            options.forEach(option => {
                insertAfter(prev.div, option.div);
                prev = option;
            });
            MenuOption.head = prev;
        }
        static toggleDisable() {
            this.disables.forEach(d => {
                d.disabled = !this.checked;
            });
        }
        static init(head) {
            if (head) {
                this.head = { div: head };
                return true;
            }
            return false;
        }
        static addDisable(checkbox, ...disables) {
            const checkboxEx = checkbox;
            if (!checkboxEx.disables) {
                checkboxEx.disables = [];
            }
            checkboxEx.disables = checkboxEx.disables.concat(disables);
        }
    }
    class MenuOptionWithButton extends MenuOption {
        constructor(init) {
            super(init);
            this.button = document.createElement('button');
            this.button.innerText = '設定';
            this.button.classList.add('btn');
            this.button.style.marginLeft = '4px';
            this.div.appendChild(this.button);
        }
    }
    class PopupWindow {
        constructor(openButton, set, onsave, onsavecancelled) {
            this.container = document.createElement('div');
            this.container.style.display = 'none';
            this.container.style.position = 'fixed';
            this.container.style.top = '0';
            this.container.style.left = '0';
            this.container.style.width = '100%';
            this.container.style.height = '100%';
            this.container.style.zIndex = '14';
            this.container.style.overflow = 'auto';
            this.container.addEventListener('mouseup', (e) => e.stopPropagation());
            this.container.addEventListener('click', () => {
                this.container.style.display = 'none';
            });
            this.dialog = document.createElement('div');
            this.dialog.style.position = 'relative';
            this.dialog.style.margin = 'auto';
            this.dialog.style.top = '15%';
            this.dialog.style.width = '400px';
            this.dialog.style.height = '500px';
            this.dialog.style.padding = '20px';
            this.dialog.style.backgroundColor = 'white';
            this.dialog.style.overflow = 'hidden';
            this.dialog.addEventListener('click', (e) => e.stopPropagation());
            this.container.appendChild(this.dialog);
            insertAfter(document.getElementById('optionView'), this.container);
            openButton.addEventListener('click', () => {
                this.container.style.display = '';
            });
            this.textarea = document.createElement('textarea');
            this.textarea.style.boxSizing = 'border-box';
            this.textarea.style.width = '100%';
            this.textarea.style.height = '100%';
            this.textarea.style.resize = 'none';
            this.textarea.value = Array.from(set).join('\n');
            this.dialog.appendChild(this.textarea);
            this.onsave = onsave;
            this.onsavecancelled = onsavecancelled;
        }
    }
    class FakeDiv {
        constructor(...elements) {
            this.elements = elements;
            this.isHidden = false;
            this.styles = new Array(elements.length).fill({
                display: '',
                width: '',
                height: '',
                padding: '',
                visibility: ''
            });
        }
        hide() {
            if (this.isHidden) {
                return;
            }
            this.isHidden = true;
            for (let i = 0; i < this.elements.length; i++) {
                this.styles[i].display = this.elements[i].style.display;
                this.elements[i].style.display = 'none';
            }
        }
        show() {
            if (!this.isHidden) {
                return;
            }
            this.isHidden = false;
            for (let i = 0; i < this.elements.length; i++) {
                this.elements[i].style.display = this.styles[i].display;
            }
        }
        minimize() {
            for (let i = 0; i < this.elements.length; i++) {
                this.styles[i].width = this.elements[i].style.width;
                this.styles[i].height = this.elements[i].style.height;
                this.styles[i].padding = this.elements[i].style.padding;
                this.styles[i].visibility = this.elements[i].style.visibility;
                this.elements[i].style.width = '0';
                this.elements[i].style.height = '0';
                this.elements[i].style.padding = '0';
                this.elements[i].style.visibility = 'hidden';
            }
        }
        restore() {
            for (let i = 0; i < this.elements.length; i++) {
                this.elements[i].style.width = this.styles[i].width;
                this.elements[i].style.height = this.styles[i].height;
                this.elements[i].style.padding = this.styles[i].padding;
                this.elements[i].style.visibility = this.styles[i].visibility;
            }
        }
    }
    class Post {
        constructor(container, urls) {
            this.container = container;
            this.urls = urls;
        }
        static getMostFrequentName(posts) {
            const nameToCount = new Map();
            let mostFrequentName = '';
            for (let i = 0; i < posts.length; i++) {
                const name = posts[i].name;
                nameToCount.set(name, (nameToCount.get(name) || 0) + 1);
                if (nameToCount.get(name) > (nameToCount.get(mostFrequentName) || 0)) {
                    mostFrequentName = name;
                }
            }
            return mostFrequentName;
        }
    }
    class NewPost extends Post {
        constructor(container, urls) {
            super(container, urls);
        }
        get name() {
            const fullNameNode = this.container.elements[0].firstElementChild.children[1];
            const nameNode = fullNameNode.firstElementChild;
            return nameNode.textContent;
        }
        get isp() {
            const fullNameNode = this.container.elements[0].firstElementChild.children[1];
            const nameNode = fullNameNode.firstElementChild;
            const ispNode = fullNameNode.lastElementChild;
            if (!ispNode || nameNode === ispNode) {
                return '';
            }
            return ispNode.tagName === 'B' ? ispNode.previousSibling.textContent : ispNode.lastChild.previousSibling.textContent;
        }
        get id() {
            return this.container.elements[0].firstElementChild.lastElementChild.textContent;
        }
        get comment() {
            return this.container.elements[0].lastElementChild.firstElementChild.innerText;
        }
        isProbably(name) {
            const fullNameNode = this.container.elements[0].firstElementChild.children[1];
            return fullNameNode.innerText.includes(name);
        }
    }
    class OldPost extends Post {
        constructor(container, urls) {
            super(container, urls);
        }
        get name() {
            return this.container.elements[0].firstElementChild.firstElementChild.textContent;
        }
        get isp() {
            const nameNode = this.container.elements[0].firstElementChild.firstElementChild;
            const ispNode = this.container.elements[0].firstElementChild.lastElementChild.previousSibling;
            if (!ispNode || ispNode === nameNode) {
                return '';
            }
            return ispNode.textContent;
        }
        get id() {
            return this.container.elements[0].lastChild.textContent;
        }
        get comment() {
            return this.container.elements[1].innerText;
        }
        isProbably(name) {
            const fullNameNode = this.container.elements[0].firstElementChild;
            return fullNameNode.innerText.includes(name);
        }
    }
    const settings = (() => {
        const defaultSettings = {
            isVisible: true,
            isDraggable: true,
            isEmbedded: true,
            isBlocked: true,
            isSB: true,
            blacklist: new Set(),
            sblist: new Set(),
            save: () => {
                const gmSettings = Object.assign({}, defaultSettings);
                gmSettings.blacklist = Array.from(gmSettings.blacklist);
                gmSettings.sblist = Array.from(gmSettings.sblist);
                GM_setValue('5ch Enhancer', gmSettings);
            }
        };
        const gmSettings = GM_getValue('5ch Enhancer');
        if (Array.isArray(gmSettings.blacklist)) {
            gmSettings.blacklist = new Set(gmSettings.blacklist);
        }
        if (Array.isArray(gmSettings.sblist)) {
            gmSettings.sblist = new Set(gmSettings.sblist);
        }
        return Object.assign(defaultSettings, gmSettings);
    })();
    const twttr = (() => {
        if (!settings.isEmbedded) {
            return null;
        }
        unsafeWindow.twttr = (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0], t = unsafeWindow.twttr || {};
            if (d.getElementById(id))
                return t;
            js = d.createElement(s);
            js.id = id;
            js.src = "https://platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js, fjs);
            t._e = [];
            t.ready = function (f) {
                t._e.push(f);
            };
            return t;
        }(unsafeWindow.document, "script", "twitter-wjs"));
        return unsafeWindow.twttr;
    })();
    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            mutation.addedNodes.forEach(addedNode => {
                if (addedNode.nodeType === Node.ELEMENT_NODE) {
                    observer.dealWith(addedNode);
                }
            });
        });
    });
    observer.dealWith = (() => {
        const functionMap = {};
        functionMap['https://agree.5ch.net/js/thumbnailer.js'] = function () {
            this.remove();
        };
        return (node) => {
            const f = functionMap[node.src];
            if (f) {
                f.call(node);
            }
        };
    })();
    observer.observe(document, { childList: true, subtree: true });
    const imgObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    if (!entry.isIntersecting) {
                        return;
                    }
                    entry.target.src = entry.target.dataset.src;
                    imgObserver.unobserve(entry.target);
                }, 500);
            }
        });
    }, { rootMargin: `${window.innerHeight}px` });
    const divObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.imgs.forEach((img) => {
                    if (img.src === '') {
                        img.src = img.dataset.src;
                    }
                });
                divObserver.unobserve(entry.target);
            }
        });
    }, { rootMargin: `${window.innerHeight}px` });
    document.addEventListener('DOMContentLoaded', () => {
        observer.disconnect();
        const scroll = document.createElement('div');
        scroll.style.fontSize = '50px';
        scroll.style.position = 'fixed';
        scroll.style.bottom = '5%';
        scroll.style.right = '4%';
        scroll.style.zIndex = '2';
        scroll.draggable = false;
        scroll.style.userSelect = 'none';
        scroll.innerText = '🔼';
        scroll.onmouseover = () => scroll.style.filter = 'brightness(0.8)';
        scroll.onmousedown = () => scroll.style.filter = 'brightness(0.6)';
        scroll.onmouseup = () => scroll.style.filter = 'brightness(0.8)';
        scroll.onmouseout = () => scroll.style.filter = '';
        scroll.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
        document.body.appendChild(scroll);
        const threads = document.querySelector('div.THREAD_MENU > div');
        if (threads) {
            for (const thread of threads.children) {
                const number = thread.firstElementChild;
                const title = thread.lastElementChild;
                title.href = number.href.slice(0, -3);
                title.target = '_blank';
                title.rel = 'noopener';
            }
        }
        const modal = {
            imgs: {
                map: new Map(),
                array: [],
                index: 0
            },
            container: document.createElement('div'),
            img: document.createElement('img'),
            isDown: false,
            isDragging: false,
            startX: 0,
            startY: 0,
            previousX: 0,
            previousY: 0,
            overflow: ''
        };
        modal.container.style.display = 'none';
        modal.container.style.position = 'fixed';
        modal.container.style.top = '0';
        modal.container.style.left = '0';
        modal.container.style.width = '100%';
        modal.container.style.height = '100%';
        modal.container.style.zIndex = '2';
        modal.container.style.overflow = 'auto';
        window.addEventListener('keydown', (e) => {
            if (modal.container.style.display === 'none' || e.repeat || modal.imgs.array.length === 0) {
                return;
            }
            switch (e.keyCode) {
                case 65:
                case 87:
                    modal.imgs.index--;
                    break;
                case 68:
                case 83:
                    modal.imgs.index++;
                    break;
            }
            if (modal.imgs.index < 0) {
                modal.imgs.index = modal.imgs.array.length - 1;
            }
            else if (modal.imgs.index >= modal.imgs.array.length) {
                modal.imgs.index = 0;
            }
            const nextImg = modal.imgs.array[modal.imgs.index];
            if (nextImg.src === '') {
                nextImg.src = nextImg.dataset.src;
                imgObserver.unobserve(nextImg);
            }
            modal.img.src = nextImg.src;
        });
        modal.container.addEventListener("click", () => {
            if (modal.isDragging && settings.isDraggable) {
                return;
            }
            modal.container.style.display = 'none';
            document.body.style.overflow = modal.overflow;
        });
        modal.container.addEventListener('mousedown', (e) => {
            if (!settings.isDraggable) {
                return;
            }
            modal.isDown = true;
            modal.isDragging = false;
            modal.startX = e.screenX;
            modal.startY = e.screenY;
        });
        window.addEventListener('mousemove', (e) => {
            if (!settings.isDraggable) {
                return;
            }
            const threshold = 1;
            const deltaX = Math.abs(e.screenX - modal.previousX);
            const deltaY = Math.abs(e.screenY - modal.previousY);
            modal.previousX = e.screenX;
            modal.previousY = e.screenY;
            if (deltaX <= threshold && deltaY <= threshold) {
                return;
            }
            if (modal.isDown) {
                modal.isDragging = true;
                modal.container.scrollBy(modal.startX - e.screenX, modal.startY - e.screenY);
                modal.startX = e.screenX;
                modal.startY = e.screenY;
            }
            else {
                modal.isDragging = false;
            }
        });
        window.addEventListener('mouseup', () => {
            if (!settings.isDraggable) {
                return;
            }
            modal.isDown = false;
        });
        modal.img.style.margin = 'auto';
        modal.img.draggable = !settings.isDraggable;
        modal.container.appendChild(modal.img);
        document.body.appendChild(modal.container);
        const imgOnclick = function () {
            modal.imgs.index = modal.imgs.map.get(this) || 0;
            modal.img.src = this.src;
            modal.overflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            modal.container.style.display = 'flex';
        };
        const appendImageAfter = (element) => {
            const fragment = document.createDocumentFragment();
            fragment.appendChild(document.createElement('br'));
            const img = new Image();
            img.dataset.src = trimTwitterImageUrl(element.innerText);
            img.style.maxWidth = '800px';
            img.addEventListener('click', imgOnclick);
            imgObserver.observe(img);
            fragment.appendChild(img);
            insertAfter(element, fragment);
            return img;
        };
        let menuState = 1 /* MenuState.NOT_CREATED */;
        const createMenu = () => {
            if (!window.location.pathname.includes('read.cgi')) {
                menuState = 2 /* MenuState.NOT_APPLICABLE */;
                return;
            }
            if (!MenuOption.init(document.querySelector('div.option_style_8'))) {
                menuState = 1 /* MenuState.NOT_CREATED */;
                return;
            }
            menuState = 0 /* MenuState.CREATED */;
            const thumbnailOption = new MenuOption({
                text: 'サムネイル画像を表示する',
                checked: settings.isVisible,
                onclick: MenuOption.toggleDisable,
                onsave: () => {
                    settings.isVisible = thumbnailOption.checkbox.checked;
                },
                onsavecancelled: () => {
                    thumbnailOption.checkbox.checked = settings.isVisible;
                    MenuOption.toggleDisable.call(thumbnailOption.checkbox);
                }
            });
            const dragOption = new MenuOption({
                text: 'ドラッグで画像を移動する',
                checked: settings.isDraggable,
                onsave: () => {
                    settings.isDraggable = dragOption.checkbox.checked;
                },
                onsavecancelled: () => {
                    dragOption.checkbox.checked = settings.isDraggable;
                }
            });
            dragOption.checkbox.disabled = !settings.isVisible;
            MenuOption.addDisable(thumbnailOption.checkbox, dragOption.checkbox);
            const embedOption = new MenuOption({
                text: 'ツイートを埋め込む',
                checked: settings.isEmbedded,
                onsave: () => {
                    settings.isEmbedded = embedOption.checkbox.checked;
                },
                onsavecancelled: () => {
                    embedOption.checkbox.checked = settings.isEmbedded;
                }
            });
            const blockOption = new MenuOptionWithButton({
                text: 'NGワード',
                checked: settings.isBlocked,
                onclick: MenuOption.toggleDisable,
                onsave: () => {
                    settings.isBlocked = blockOption.checkbox.checked;
                },
                onsavecancelled: () => {
                    blockOption.checkbox.checked = settings.isBlocked;
                    MenuOption.toggleDisable.call(blockOption.checkbox);
                }
            });
            blockOption.button.disabled = !settings.isBlocked;
            MenuOption.addDisable(blockOption.checkbox, blockOption.button);
            const blockOptionPopupWindow = new PopupWindow(blockOption.button, settings.blacklist, () => {
                settings.blacklist = new Set(blockOptionPopupWindow.textarea.value.split('\n').filter(word => word.length > 0));
                blockOptionPopupWindow.textarea.value = Array.from(settings.blacklist).join('\n');
            }, () => {
                blockOptionPopupWindow.textarea.value = Array.from(settings.blacklist).join('\n');
            });
            const sbiPhoneOption = new MenuOptionWithButton({
                text: 'SB-iPhoneらふたん特殊対策',
                checked: settings.isSB,
                onclick: MenuOption.toggleDisable,
                onsave: () => {
                    settings.isSB = sbiPhoneOption.checkbox.checked;
                },
                onsavecancelled: () => {
                    sbiPhoneOption.checkbox.checked = settings.isSB;
                    MenuOption.toggleDisable.call(sbiPhoneOption.checkbox);
                }
            });
            sbiPhoneOption.button.disabled = !settings.isSB;
            MenuOption.addDisable(sbiPhoneOption.checkbox, sbiPhoneOption.button);
            thumbnailOption.checkbox.addEventListener('click', () => {
                if (sbiPhoneOption.checkbox.checked && !thumbnailOption.checkbox.checked) {
                    alert('サムネイルをオフにしつつSB-iPhone対策をオンにするとすべてのSB-iPhoneのスレが表示しなくなります');
                }
            });
            sbiPhoneOption.checkbox.addEventListener('click', () => {
                if (sbiPhoneOption.checkbox.checked && !thumbnailOption.checkbox.checked) {
                    alert('サムネイルをオフにしつつSB-iPhone対策をオンにするとすべてのSB-iPhoneのスレが表示しなくなります');
                }
            });
            const sbiPhoneOptionPopupWindow = new PopupWindow(sbiPhoneOption.button, settings.sblist, () => {
                settings.sblist = new Set(sbiPhoneOptionPopupWindow.textarea.value.split('\n').filter(word => word.length > 0));
                sbiPhoneOptionPopupWindow.textarea.value = Array.from(settings.sblist).join('\n');
            }, () => {
                sbiPhoneOptionPopupWindow.textarea.value = Array.from(settings.sblist).join('\n');
            });
            MenuOption.insert(thumbnailOption, dragOption, embedOption, blockOption, sbiPhoneOption);
            const saveButton = document.getElementById('saveOptions');
            saveButton === null || saveButton === void 0 ? void 0 : saveButton.addEventListener('click', () => {
                thumbnailOption.onsave();
                dragOption.onsave();
                embedOption.onsave();
                modal.img.draggable = !settings.isDraggable;
                blockOption.onsave();
                blockOptionPopupWindow.onsave();
                sbiPhoneOption.onsave();
                sbiPhoneOptionPopupWindow.onsave();
                settings.save();
            });
            const cancels = [
                document.getElementById('cancelOptions'),
                document.getElementById('close_options'),
                document.querySelector('div.option_container_bg')
            ];
            const onsavecancelled = () => {
                thumbnailOption.onsavecancelled();
                dragOption.onsavecancelled();
                embedOption.onsavecancelled();
                blockOption.onsavecancelled();
                blockOptionPopupWindow.onsavecancelled();
                sbiPhoneOption.onsavecancelled();
                sbiPhoneOptionPopupWindow.onsavecancelled();
            };
            cancels.forEach(cancel => cancel === null || cancel === void 0 ? void 0 : cancel.addEventListener('click', onsavecancelled));
        };
        setTimeout(createMenu, 2000);
        const finalCallback = (posts) => {
            const mostFrequentName = Post.getMostFrequentName(posts);
            posts.forEach(post => {
                // const isSbiPhone = post.isp === '(SB-iPhone)'
                const isSbiPhone = post.isProbably('SB-iPhone');
                const isTroll = post.isProbably('◆');
                let observedDiv;
                let forceHidden = false;
                if (!post.container.isHidden && settings.isSB) {
                    if (isTroll) {
                        post.container.hide();
                        forceHidden = true;
                    }
                    else if (isSbiPhone) {
                        if (!settings.isVisible || post.name !== mostFrequentName) {
                            post.container.hide();
                            forceHidden = true;
                        }
                        else if (post.urls.length > 0) {
                            post.container.hide();
                        }
                    }
                }
                if (!post.container.isHidden && settings.isBlocked) {
                    if (Array.from(settings.blacklist).some(word => post.comment.includes(word))) {
                        post.container.hide();
                        forceHidden = true;
                    }
                }
                post.urls.forEach(url => {
                    const matchResult = url.href.match(/^.+?\/\?./);
                    if (matchResult) {
                        url.href = url.innerText;
                    }
                    if (settings.isEmbedded && url.innerText.match(/twitter\.com\/.+?\/status\/./)) {
                        GM_xmlhttpRequest({
                            method: 'GET',
                            url: `https://publish.twitter.com/oembed?url=${url.innerText}&omit_script=true`,
                            onload: (response) => {
                                const tweet = createTweet(response.responseText);
                                if (!tweet) {
                                    return;
                                }
                                insertAfter(url, tweet);
                                if (tweet.nextElementSibling && tweet.nextElementSibling.tagName === 'BR') {
                                    tweet.nextElementSibling.remove();
                                }
                                (function retry(count = 0) {
                                    if (count === 3) {
                                        return;
                                    }
                                    if (twttr.widgets && twttr.widgets.load) {
                                        twttr.widgets.load(tweet);
                                    }
                                    else {
                                        setTimeout(retry, 5000, count + 1);
                                    }
                                })();
                            }
                        });
                    }
                    if (settings.isVisible && url.innerText.match(/jpg|jpeg|gif|png|bmp|webp/)) {
                        const img = appendImageAfter(url);
                        modal.imgs.map.set(img, modal.imgs.array.length);
                        modal.imgs.array.push(img);
                        if (settings.isSB && img.dataset.src.match(/^https?:\/\/(i\.)?imgur/) && img.dataset.src.endsWith('jpg')) {
                            const space = document.createTextNode('\xa0\xa0');
                            const blockButton = document.createElement('a');
                            blockButton.innerText = 'ブロック';
                            blockButton.href = 'javascript:void(0)';
                            blockButton.addEventListener('click', () => {
                                post.container.hide();
                                if (img.src === '') {
                                    img.src = img.dataset.src;
                                    imgObserver.unobserve(img);
                                }
                                if (img.complete) {
                                    fetchAndHashImage(img.dataset.src, (hash) => {
                                        settings.sblist.add(hash);
                                        settings.save();
                                    });
                                }
                                else {
                                    img.addEventListener('load', () => {
                                        fetchAndHashImage(img.dataset.src, (hash) => {
                                            settings.sblist.add(hash);
                                            settings.save();
                                        });
                                    });
                                }
                            });
                            insertAfter(url, space);
                            insertAfter(space, blockButton);
                            if (isSbiPhone) {
                                if (!observedDiv) {
                                    const currentDiv = post.container.elements[0];
                                    observedDiv = document.createElement('div');
                                    observedDiv.imgs = [];
                                    observedDiv.post = post;
                                    observedDiv.count = 0;
                                    currentDiv.parentElement.insertBefore(observedDiv, currentDiv);
                                    divObserver.observe(observedDiv);
                                }
                                observedDiv.imgs.push(img);
                                img.addEventListener('load', () => {
                                    if (observedDiv.containsBlockedImage) {
                                        return;
                                    }
                                    fetchAndHashImage(img.dataset.src, (hash) => {
                                        observedDiv.count++;
                                        if (settings.sblist.has(hash)) {
                                            observedDiv.containsBlockedImage = true;
                                        }
                                        if (observedDiv.count === observedDiv.imgs.length && !observedDiv.containsBlockedImage && !forceHidden) {
                                            observedDiv.post.container.show();
                                        }
                                    });
                                });
                            }
                            else {
                                img.addEventListener('load', () => {
                                    if (post.container.isHidden) {
                                        return;
                                    }
                                    fetchAndHashImage(img.dataset.src, (hash) => {
                                        if (settings.sblist.has(hash)) {
                                            post.container.hide();
                                        }
                                    });
                                });
                            }
                        }
                    }
                });
            });
        };
        const newPostDivs = document.querySelectorAll('div.post');
        if (newPostDivs.length !== 0) {
            const newPosts = Array.from(newPostDivs).map(newPostDiv => {
                const br = newPostDiv.nextElementSibling;
                return new NewPost(new FakeDiv(newPostDiv, br), Array.from(newPostDiv.querySelectorAll('span.escaped a')));
            });
            finalCallback(newPosts);
        }
        else {
            const oldPostTitles = Array.from(document.querySelectorAll('dl.thread > dt'));
            const oldPosts = oldPostTitles
                .filter(oldPostTitles => oldPostTitles.nextElementSibling !== null)
                .map(oldPostTitle => {
                const oldPostContent = oldPostTitle.nextElementSibling;
                return new OldPost(new FakeDiv(oldPostTitle, oldPostContent), Array.from(oldPostContent.querySelectorAll('a')));
            });
            setTimeout(finalCallback, 1000, oldPosts);
        }
    });
})();